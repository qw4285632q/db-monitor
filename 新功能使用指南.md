# 数据库监控系统 v2.0 - 新功能快速指南

## 🎉 7大新功能已全部上线

本次更新新增了7个实用功能，让数据库监控和运维更加高效！

---

## 📋 功能概览

| 功能 | 优先级 | 状态 | 位置 |
|------|--------|------|------|
| SQL详情弹窗 | ⭐⭐⭐⭐⭐ | ✅ 已完成 | 监控面板 → 点击"详情" |
| 执行计划自动采集 | ⭐⭐⭐⭐⭐ | ✅ 已完成 | 自动采集，详情弹窗中查看 |
| Kill会话功能 | ⭐⭐⭐⭐ | ✅ 已完成 | 详情弹窗/实时监控 → "终止会话" |
| SQL指纹去重 | ⭐⭐⭐⭐ | ✅ 已完成 | 后台自动运行 |
| 性能指标采集 | ⭐⭐⭐ | ✅ 已完成 | 详情弹窗中查看 |
| 告警历史记录 | ⭐⭐⭐ | ✅ 已完成 | 后台自动记录 |
| 实时监控仪表板 | ⭐⭐⭐ | ✅ 已完成 | 顶部导航 → "实时监控" |

---

## 🚀 快速开始

### 1️⃣ 升级数据库表结构

```bash
cd C:\运维工具类\database-monitor
mysql -u root -p db_monitor < scripts/init_database.sql
```

### 2️⃣ 重启采集器

```bash
# Windows
taskkill /F /IM python.exe /FI "WINDOWTITLE eq collector*"
python scripts/collector_enhanced.py
```

### 3️⃣ 重启Web服务

```bash
python app_new.py
```

### 4️⃣ 刷新浏览器

按 `Ctrl + F5` 强制刷新，清除缓存

---

## 💡 使用示例

### 场景1：查看慢SQL完整信息

**步骤**：
1. 打开监控面板
2. 找到慢SQL记录
3. 点击"详情"按钮
4. 查看：
   - ✅ 完整SQL文本
   - ✅ 执行计划（自动EXPLAIN）
   - ✅ 扫描了多少行
   - ✅ 返回了多少行
   - ✅ 是否全表扫描
   - ✅ 使用了哪些索引

### 场景2：紧急处理长时间运行的SQL

**步骤**：
1. 点击顶部"实时监控"
2. 开启"自动刷新(5秒)"
3. 找到执行时间过长的SQL
4. 点击"Kill"按钮
5. 确认终止

### 场景3：分析为什么SQL这么慢

**步骤**：
1. 监控面板 → 点击"详情"
2. 查看执行计划部分
3. 检查：
   - 是否显示"全表扫描：是" → 需要加索引
   - 查看"使用的索引" → 如果是NONE，需要加索引
   - 查看扫描行数 → 如果过大，优化WHERE条件或加索引
4. 根据执行计划优化SQL

---

## 🎯 核心功能详解

### ⭐ SQL详情弹窗

**在哪里**：监控面板 → 任意SQL记录 → 点击"详情"按钮

**能看到什么**：
- 完整SQL语句（代码高亮显示）
- 会话ID、用户、客户端信息
- 扫描行数、返回行数
- CPU时间、是否全表扫描
- 使用的索引
- 执行计划（表格形式）
- 终止会话按钮（如果SQL还在运行）

**典型用法**：
```
1. 发现慢SQL
2. 点击详情查看执行计划
3. 发现全表扫描
4. 记下表名和条件字段
5. 添加索引
```

### ⭐ 实时监控仪表板

**在哪里**：顶部导航 → "实时监控"

**特色功能**：
- 🔄 5秒自动刷新
- 🎯 只显示当前正在运行的SQL
- 📊 统计：活动SQL数、最长执行时间、阻塞会话
- 🔪 一键Kill会话
- 🔍 支持实例过滤

**典型用法**：
```
1. 用户反馈"系统很卡"
2. 打开实时监控
3. 开启自动刷新
4. 发现有SQL执行了300秒
5. 点击Kill终止它
6. 系统恢复正常
```

### ⭐ 执行计划自动采集

**工作原理**：
- 检测到慢SQL时，自动执行 `EXPLAIN <SQL>`
- 将结果存入数据库
- 在详情弹窗中展示

**能看到什么**：
```
表格形式的执行计划：
┌────────┬──────┬──────────────┬─────┬──────────┬─────────────┐
│ table  │ type │ possible_keys│ key │ rows     │ Extra       │
├────────┼──────┼──────────────┼─────┼──────────┼─────────────┤
│ orders │ ALL  │ NULL         │ NULL│ 1000000  │ Using where │
└────────┴──────┴──────────────┴─────┴──────────┴─────────────┘
                                      ↑
                                      这个说明要扫描100万行！
```

**优化建议**：
- `type = ALL` → 全表扫描，需要加索引
- `key = NULL` → 没用索引，需要加索引
- `rows` 很大 → 扫描行数多，加索引或优化SQL
- `Extra = Using filesort` → 需要排序优化

---

## 📊 性能指标说明

### 在详情弹窗中显示的指标

| 指标 | 含义 | 优化目标 |
|------|------|----------|
| **扫描行数** | 读取了多少行数据 | 越小越好，理想<1000 |
| **返回行数** | 最终返回了多少行 | 与扫描行数比例接近1:1最好 |
| **CPU时间** | 消耗的CPU时间 | 越小越好 |
| **全表扫描** | 是否扫描整张表 | 应该是"否" |
| **使用的索引** | 用了哪些索引 | 不应该是"NONE" |

**示例分析**：
```
扫描行数: 1,000,000
返回行数: 10
全表扫描: 是
使用的索引: NONE

分析：扫描了100万行，只返回10行，效率极低！
建议：WHERE条件字段需要加索引
```

---

## ⚡ Kill会话功能使用

### 何时使用Kill

✅ **应该Kill**：
- SQL执行超过1小时还没结束
- 阻塞了其他重要业务
- 明确知道SQL有问题
- 误操作执行了不该执行的SQL

❌ **不应该Kill**：
- 正常的批处理任务
- 备份、导入导出操作
- 不确定SQL用途时

### Kill操作步骤

**方法1：从详情弹窗Kill**
```
1. 监控面板 → 找到慢SQL
2. 点击"详情"
3. 确认是需要终止的SQL
4. 点击"终止会话"按钮
5. 确认对话框 → 确定
6. 等待提示"会话已成功终止"
```

**方法2：从实时监控Kill**
```
1. 实时监控页面
2. 找到需要终止的SQL
3. 点击该行的"Kill"按钮
4. 确认对话框 → 确定
5. 页面自动刷新，SQL消失
```

---

## 🔍 SQL指纹去重说明

**什么是SQL指纹**：
将SQL中的参数值替换成占位符，生成MD5哈希值

**示例**：
```sql
原始SQL 1: SELECT * FROM users WHERE id = 123
原始SQL 2: SELECT * FROM users WHERE id = 456
原始SQL 3: SELECT * FROM users WHERE id = 789

指纹SQL:   SELECT * FROM users WHERE id = ?
MD5:       a1b2c3d4e5f6...

结果：3条SQL有相同指纹，可以合并分析
```

**用途**：
1. 避免相同模板的SQL重复告警
2. 统计哪种SQL模板最常见
3. 分析SQL性能趋势

---

## 📈 告警历史查询

查看最近的告警：
```sql
SELECT
    i.db_project,
    a.alert_type,
    a.alert_level,
    a.alert_message,
    a.created_at
FROM alert_history a
LEFT JOIN db_instance_info i ON a.db_instance_id = i.id
ORDER BY a.created_at DESC
LIMIT 20;
```

查看告警频率Top10：
```sql
SELECT
    alert_identifier,
    COUNT(*) as alert_count,
    MIN(created_at) as first_time,
    MAX(created_at) as last_time
FROM alert_history
WHERE alert_type = 'slow_sql'
GROUP BY alert_identifier
ORDER BY alert_count DESC
LIMIT 10;
```

---

## 🛠️ 故障排查

### 问题1：看不到执行计划

**可能原因**：
- SQL不是SELECT语句（INSERT/UPDATE/DELETE不支持EXPLAIN）
- 执行计划采集失败
- 数据库权限不足

**解决方法**：
```sql
-- 检查采集器日志
tail -f /path/to/collector.log

-- 手动测试EXPLAIN
EXPLAIN SELECT ...
```

### 问题2：Kill会话失败

**可能原因**：
- 会话已经结束
- 权限不足
- 网络连接问题

**解决方法**：
```sql
-- 检查会话是否还存在
SELECT * FROM information_schema.processlist
WHERE id = 12345;

-- 检查监控账号权限
SHOW GRANTS FOR 'monitor_user'@'%';
-- 应该有 PROCESS, SUPER 权限
```

### 问题3：实时监控没数据

**可能原因**：
- 最小执行时间设置过高
- 当前确实没有慢SQL
- 实例连接失败

**解决方法**：
1. 降低"最小执行时间"到1秒
2. 检查实例连接配置
3. 查看浏览器控制台报错

---

## 📞 技术支持

遇到问题？
1. 查看日志：`tail -f collector.log`
2. 检查数据库表结构是否更新
3. 确认浏览器缓存已清除
4. 查看详细文档：`FEATURE_UPDATE_2026-01-26.md`

---

**祝使用愉快！** 🎉
