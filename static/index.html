<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“Long SQLç›‘æ§ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #333; min-height: 100vh; }

        /* Navigation */
        .nav-bar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 0 20px; display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-brand { color: white; font-size: 20px; font-weight: bold; padding: 15px 0; margin-right: 40px; }
        .nav-tabs { display: flex; gap: 5px; }
        .nav-tab { color: rgba(255,255,255,0.7); padding: 15px 25px; cursor: pointer; border: none; background: none; font-size: 14px; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .nav-tab:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-tab.active { color: white; border-bottom-color: white; background: rgba(255,255,255,0.1); }
        .nav-right { margin-left: auto; color: rgba(255,255,255,0.8); font-size: 13px; }

        /* Container */
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .page { display: none; }
        .page.active { display: block; }

        /* Cards */
        .card { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; }
        .card-title { font-size: 16px; font-weight: 600; color: #333; }
        .card-body { padding: 20px; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-label { font-size: 13px; color: #666; margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: bold; color: #333; }
        .stat-card.primary .stat-value { color: #667eea; }
        .stat-card.success .stat-value { color: #28a745; }
        .stat-card.warning .stat-value { color: #ffc107; }
        .stat-card.danger .stat-value { color: #dc3545; }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-size: 14px; color: #555; font-weight: 500; }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; transition: border-color 0.3s; }
        .form-control:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .form-text { font-size: 12px; color: #888; margin-top: 4px; }

        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }

        /* Tables */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #555; font-size: 13px; }
        tr:hover { background: #f8f9fa; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-secondary { background: #e9ecef; color: #495057; }
        .badge-primary { background: #cce5ff; color: #004085; }

        /* Filters */
        .filters { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 12px; color: #666; min-height: 18px; line-height: 18px; }
        .filter-group select, .filter-group input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; height: 40px; box-sizing: border-box; }
        .filter-group input[type="number"] { width: 180px; }

        /* Charts */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-container { height: 250px; position: relative; }

        /* Pagination */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; padding: 20px 0; }
        .pagination button { padding: 8px 15px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; }
        .pagination button:hover:not(:disabled) { background: #667eea; color: white; border-color: #667eea; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination span { color: #666; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 10px; width: 90%; max-width: 700px; max-height: 90vh; overflow: auto; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 18px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }

        /* SQL Text */
        .sql-text { font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; background: #f8f9fa; padding: 10px; border-radius: 6px; white-space: pre-wrap; word-break: break-all; max-height: 200px; overflow: auto; }

        /* Status */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-dot.online { background: #28a745; }
        .status-dot.offline { background: #dc3545; }

        /* Alert */
        .alert { padding: 12px 15px; border-radius: 6px; margin-bottom: 15px; font-size: 14px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #cce5ff; color: #004085; border: 1px solid #b8daff; }

        /* Loading */
        .loading { text-align: center; padding: 40px; color: #666; }
        .spinner { display: inline-block; width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Empty state */
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state svg { width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.5; }

        /* Actions */
        .actions { display: flex; gap: 5px; }
        .action-btn { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .action-btn.edit { background: #e3f2fd; color: #1976d2; }
        .action-btn.delete { background: #ffebee; color: #d32f2f; }
        .action-btn.test { background: #e8f5e9; color: #2e7d32; }
        .action-btn:hover { opacity: 0.8; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Info Card for Detail Modal */
        .info-card { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; }
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e9ecef; }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: #666; font-size: 13px; font-weight: 500; }
        .info-value { color: #333; font-size: 13px; text-align: right; }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <div class="nav-brand">SQLç›‘æ§ç³»ç»Ÿ</div>
        <div class="nav-tabs">
            <button class="nav-tab active" data-page="monitor">ç›‘æ§é¢æ¿</button>
            <button class="nav-tab" data-page="performance">æ€§èƒ½æŒ‡æ ‡</button>
            <button class="nav-tab" data-page="realtime">å®æ—¶ç›‘æ§</button>
            <button class="nav-tab" data-page="deadlock">æ­»é”ç›‘æ§</button>
            <button class="nav-tab" data-page="instances">å®ä¾‹ç®¡ç†</button>
            <button class="nav-tab" data-page="collectors">é‡‡é›†å™¨é…ç½®</button>
            <button class="nav-tab" data-page="config">ç³»ç»Ÿé…ç½®</button>
        </div>
        <div class="nav-right">
            <span id="currentTime"></span>
        </div>
    </nav>

    <div class="container">
        <!-- Monitor Page -->
        <div id="page-monitor" class="page active">
            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card primary">
                    <div class="stat-label">ç›‘æ§å®ä¾‹æ•°</div>
                    <div class="stat-value" id="stat-instances">0</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-label">Long SQLæ€»æ•°</div>
                    <div class="stat-value" id="stat-total">0</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-label">å¹³å‡æ‰§è¡Œæ—¶é—´</div>
                    <div class="stat-value" id="stat-avg">0<small>åˆ†é’Ÿ</small></div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-label">æ­»é”æ•°</div>
                    <div class="stat-value" id="stat-deadlock">0</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="card">
                    <div class="card-header"><span class="card-title">å®ä¾‹SQLç»Ÿè®¡</span></div>
                    <div class="card-body"><div class="chart-container"><canvas id="instanceChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">SQLè¶‹åŠ¿</span></div>
                    <div class="card-body"><div class="chart-container"><canvas id="trendChart"></canvas></div></div>
                </div>
            </div>

            <!-- Filters & Data Table -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Long SQLåˆ—è¡¨</span>
                    <div class="filters">
                        <div class="filter-group">
                            <label>æ—¶é—´èŒƒå›´</label>
                            <select id="filterHours">
                                <option value="1">æœ€è¿‘1å°æ—¶</option>
                                <option value="6">æœ€è¿‘6å°æ—¶</option>
                                <option value="12">æœ€è¿‘12å°æ—¶</option>
                                <option value="24" selected>æœ€è¿‘24å°æ—¶</option>
                                <option value="72">æœ€è¿‘3å¤©</option>
                                <option value="168">æœ€è¿‘7å¤©</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>å®ä¾‹</label>
                            <select id="filterInstance"><option value="">å…¨éƒ¨å®ä¾‹</option></select>
                        </div>
                        <div class="filter-group">
                            <label>æœ€å°æ‰§è¡Œæ—¶é—´(åˆ†é’Ÿ)</label>
                            <input type="number" id="filterMinMinutes" value="0" min="0" step="0.1">
                        </div>
                        <div class="filter-group">
                            <label>æ¯é¡µæ¡æ•°</label>
                            <select id="filterPageSize">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="loadLongSQL()">æŸ¥è¯¢</button>
                        <button class="btn btn-secondary btn-sm" onclick="toggleAutoRefresh()">
                            <span id="autoRefreshIcon">â–¶</span> è‡ªåŠ¨åˆ·æ–°
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>æ£€æµ‹æ—¶é—´</th>
                                    <th>é¡¹ç›®/å®ä¾‹</th>
                                    <th>ç”¨æˆ·</th>
                                    <th>æ‰§è¡Œæ—¶é—´</th>
                                    <th>çŠ¶æ€</th>
                                    <th>SQLé¢„è§ˆ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="sqlTableBody">
                                <tr><td colspan="7" class="loading"><div class="spinner"></div><br>åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination">
                        <button id="prevPage" onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
                        <span id="pageInfo">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
                        <button id="nextPage" onclick="changePage(1)">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics Page -->
        <div id="page-performance" class="page">
            <!-- Performance Metrics Cards -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡</span>
                    <button class="btn btn-primary btn-sm" onclick="loadPerformanceMetrics()">åˆ·æ–°</button>
                </div>
                <div class="card-body">
                    <div id="performanceMetricsContainer">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prometheus System Resource Monitoring -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">ç³»ç»Ÿèµ„æºç›‘æ§ (Prometheus)</span>
                    <div class="filters">
                        <div class="filter-group">
                            <label>å®ä¾‹</label>
                            <select id="prometheusInstanceSelect" onchange="loadPrometheusMetrics()">
                                <option value="">è¯·é€‰æ‹©å®ä¾‹</option>
                            </select>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="loadPrometheusMetrics()">åˆ·æ–°</button>
                        <button class="btn btn-secondary btn-sm" onclick="checkPrometheusHealth()">æ£€æŸ¥è¿æ¥</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="prometheusHealthStatus" style="margin-bottom: 15px; display: none;"></div>
                    <div id="prometheusMetricsContainer">
                        <div class="empty-state">è¯·é€‰æ‹©å®ä¾‹æŸ¥çœ‹Prometheusç›‘æ§æŒ‡æ ‡</div>
                    </div>
                </div>
            </div>

            <!-- Prometheus SQL Server Monitoring -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">SQL Serverç›‘æ§ (Prometheus)</span>
                    <div class="filters">
                        <div class="filter-group">
                            <label>SQL Serverå®ä¾‹</label>
                            <select id="prometheusSqlServerSelect" onchange="loadPrometheusSqlServerMetrics()">
                                <option value="">è¯·é€‰æ‹©SQL Serverå®ä¾‹</option>
                            </select>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="loadPrometheusSqlServerMetrics()">åˆ·æ–°</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="prometheusSqlServerContainer">
                        <div class="empty-state">è¯·é€‰æ‹©SQL Serverå®ä¾‹æŸ¥çœ‹ç›‘æ§æŒ‡æ ‡</div>
                    </div>
                </div>
            </div>

            <!-- Blocking Queries -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">é˜»å¡æŸ¥è¯¢æ£€æµ‹ï¼ˆsys.innodb_lock_waitsï¼‰</span>
                    <div class="filters">
                        <div class="filter-group">
                            <label>é˜»å¡æ—¶é•¿(ç§’)</label>
                            <input type="number" id="blockingWaitSeconds" value="10" min="1" style="width:100px">
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="loadBlockingQueries()">æŸ¥è¯¢</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="blockingQueriesContainer">
                        <div class="empty-state">ç‚¹å‡»"æŸ¥è¯¢"æŒ‰é’®æŸ¥çœ‹é˜»å¡ä¼šè¯</div>
                    </div>
                </div>
            </div>

            <!-- Replication Status -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">ä¸»ä»å¤åˆ¶çŠ¶æ€ (MySQL)</span>
                    <button class="btn btn-primary btn-sm" onclick="loadReplicationStatus()">åˆ·æ–°</button>
                </div>
                <div class="card-body">
                    <div id="replicationStatusContainer">
                        <div class="empty-state">ç‚¹å‡»"åˆ·æ–°"æŒ‰é’®æŸ¥çœ‹å¤åˆ¶çŠ¶æ€</div>
                    </div>
                </div>
            </div>

            <!-- Always On Status -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Always On å¯ç”¨æ€§ç»„çŠ¶æ€ (SQL Server)</span>
                    <button class="btn btn-primary btn-sm" onclick="loadAlwaysOnStatus()">åˆ·æ–°</button>
                </div>
                <div class="card-body">
                    <div id="alwaysOnStatusContainer">
                        <div class="empty-state">ç‚¹å‡»"åˆ·æ–°"æŒ‰é’®æŸ¥çœ‹Always OnçŠ¶æ€</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Realtime Monitor Page -->
        <div id="page-realtime" class="page">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">å®æ—¶ç›‘æ§ - å½“å‰è¿è¡Œä¸­çš„SQL</span>
                    <div class="filters">
                        <div class="filter-group">
                            <label>å®ä¾‹</label>
                            <select id="realtimeFilterInstance"><option value="">å…¨éƒ¨å®ä¾‹</option></select>
                        </div>
                        <div class="filter-group">
                            <label>æœ€å°æ‰§è¡Œæ—¶é—´(ç§’) <small style="color:#888;font-size:11px;">(å»ºè®®â‰¥5ç§’)</small></label>
                            <input type="number" id="realtimeMinSeconds" value="5" min="0" step="1" placeholder="0=æ‰€æœ‰æŸ¥è¯¢">
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="loadRealtimeSQL()">åˆ·æ–°</button>
                        <button class="btn btn-secondary btn-sm" id="realtimeAutoRefreshBtn" onclick="toggleRealtimeRefresh()">
                            <span id="realtimeRefreshIcon">â–¶</span> è‡ªåŠ¨åˆ·æ–°(5ç§’)
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="realtimeStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div class="stat-card primary">
                            <div class="stat-label">å½“å‰æ´»åŠ¨SQL</div>
                            <div class="stat-value" id="realtimeCount">0</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-label">æœ€é•¿æ‰§è¡Œæ—¶é—´</div>
                            <div class="stat-value" id="realtimeMax">0<small>ç§’</small></div>
                        </div>
                        <div class="stat-card danger">
                            <div class="stat-label">é˜»å¡ä¼šè¯</div>
                            <div class="stat-value" id="realtimeBlocked">0</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ä¼šè¯ID</th>
                                    <th>é¡¹ç›®/å®ä¾‹</th>
                                    <th>ç”¨æˆ·</th>
                                    <th>æ‰§è¡Œæ—¶é•¿</th>
                                    <th>çŠ¶æ€</th>
                                    <th>SQLé¢„è§ˆ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="realtimeTableBody">
                                <tr><td colspan="7" class="loading"><div class="spinner"></div><br>åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Deadlock Monitor Page -->
        <div id="page-deadlock" class="page">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">æ­»é”ç›‘æ§</span>
                    <div class="filters">
                        <div class="filter-group">
                            <label>æ—¶é—´èŒƒå›´</label>
                            <select id="deadlockFilterHours">
                                <option value="1">æœ€è¿‘1å°æ—¶</option>
                                <option value="6">æœ€è¿‘6å°æ—¶</option>
                                <option value="24" selected>æœ€è¿‘24å°æ—¶</option>
                                <option value="72">æœ€è¿‘3å¤©</option>
                                <option value="168">æœ€è¿‘7å¤©</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>å®ä¾‹</label>
                            <select id="deadlockFilterInstance"><option value="">å…¨éƒ¨å®ä¾‹</option></select>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="loadDeadlocks()">æŸ¥è¯¢</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>æ£€æµ‹æ—¶é—´</th>
                                    <th>é¡¹ç›®/å®ä¾‹</th>
                                    <th>æ•°æ®åº“ç±»å‹</th>
                                    <th>å—å®³è€…ä¼šè¯</th>
                                    <th>é˜»å¡è€…ä¼šè¯</th>
                                    <th>ç­‰å¾…èµ„æº</th>
                                    <th>é”æ¨¡å¼</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="deadlockTableBody">
                                <tr><td colspan="8" class="loading"><div class="spinner"></div><br>åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination">
                        <button id="deadlockPrevPage" onclick="changeDeadlockPage(-1)">ä¸Šä¸€é¡µ</button>
                        <span id="deadlockPageInfo">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
                        <button id="deadlockNextPage" onclick="changeDeadlockPage(1)">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instances Management Page -->
        <div id="page-instances" class="page">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">æ•°æ®åº“å®ä¾‹ç®¡ç†</span>
                    <button class="btn btn-primary btn-sm" onclick="showInstanceModal()">+ æ·»åŠ å®ä¾‹</button>
                </div>
                <div class="card-body">
                    <div id="instancesAlert"></div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>é¡¹ç›®</th>
                                    <th>IPåœ°å€</th>
                                    <th>ç«¯å£</th>
                                    <th>å®ä¾‹å</th>
                                    <th>ç±»å‹</th>
                                    <th>ç”¨æˆ·</th>
                                    <th>ç¯å¢ƒ</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="instancesTableBody">
                                <tr><td colspan="10" class="loading"><div class="spinner"></div><br>åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Collectors Config Page -->
        <div id="page-collectors" class="page">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">âš™ï¸ é‡‡é›†å™¨é…ç½®ç®¡ç†</span>
                    <button class="btn btn-secondary btn-sm" onclick="loadCollectorsConfig()">åˆ·æ–°çŠ¶æ€</button>
                </div>
                <div class="card-body">
                    <div id="collectorsAlert"></div>

                    <!-- MySQLé‡‡é›†å™¨ -->
                    <div style="margin-bottom: 30px; border: 1px solid #ddd; padding: 20px; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: #007bff;">ğŸ¬ MySQL Performance Schema é‡‡é›†å™¨</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>å¯ç”¨çŠ¶æ€</label>
                                <select id="mysqlEnabled" class="form-control">
                                    <option value="true">å¯ç”¨</option>
                                    <option value="false">ç¦ç”¨</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>é‡‡é›†é—´éš” (ç§’)</label>
                                <input type="number" id="mysqlInterval" class="form-control" min="10" max="3600" step="1" value="60">
                                <small style="color: #888;">å»ºè®®: 30-120ç§’ï¼Œå¤ªé¢‘ç¹ä¼šå¢åŠ æ•°æ®åº“å¼€é”€</small>
                            </div>
                            <div class="form-group">
                                <label>æ…¢SQLé˜ˆå€¼ (ç§’)</label>
                                <input type="number" id="mysqlThreshold" class="form-control" min="1" max="3600" step="1" value="5">
                                <small style="color: #888;">åªé‡‡é›†è¶…è¿‡æ­¤æ—¶é—´çš„SQL</small>
                            </div>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            <div><strong>è¿è¡ŒçŠ¶æ€:</strong> <span id="mysqlStatus" style="font-weight: bold;">-</span></div>
                            <div><strong>ä¸‹æ¬¡è¿è¡Œ:</strong> <span id="mysqlNextRun">-</span></div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="triggerCollector('mysql')">ç«‹å³æ‰§è¡Œä¸€æ¬¡</button>
                        </div>
                    </div>

                    <!-- SQL Serveré‡‡é›†å™¨ -->
                    <div style="margin-bottom: 20px; border: 1px solid #ddd; padding: 20px; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: #28a745;">ğŸ—„ï¸ SQL Server Query Store é‡‡é›†å™¨</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>å¯ç”¨çŠ¶æ€</label>
                                <select id="sqlserverEnabled" class="form-control">
                                    <option value="true">å¯ç”¨</option>
                                    <option value="false">ç¦ç”¨</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>é‡‡é›†é—´éš” (ç§’)</label>
                                <input type="number" id="sqlserverInterval" class="form-control" min="10" max="3600" step="1" value="60">
                                <small style="color: #888;">å»ºè®®: 30-120ç§’</small>
                            </div>
                            <div class="form-group">
                                <label>æ…¢SQLé˜ˆå€¼ (ç§’)</label>
                                <input type="number" id="sqlserverThreshold" class="form-control" min="1" max="3600" step="1" value="5">
                                <small style="color: #888;">åªé‡‡é›†è¶…è¿‡æ­¤æ—¶é—´çš„SQL</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>è‡ªåŠ¨å¼€å¯Query Store</label>
                                <select id="sqlserverAutoEnable" class="form-control">
                                    <option value="false">å¦ (æ¨è)</option>
                                    <option value="true">æ˜¯</option>
                                </select>
                                <small style="color: #888;">è‡ªåŠ¨ä¸ºæœªå¼€å¯çš„æ•°æ®åº“å¯ç”¨Query Store</small>
                            </div>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            <div><strong>è¿è¡ŒçŠ¶æ€:</strong> <span id="sqlserverStatus" style="font-weight: bold;">-</span></div>
                            <div><strong>ä¸‹æ¬¡è¿è¡Œ:</strong> <span id="sqlserverNextRun">-</span></div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="triggerCollector('sqlserver')">ç«‹å³æ‰§è¡Œä¸€æ¬¡</button>
                        </div>
                    </div>

                    <!-- ä¿å­˜æŒ‰é’® -->
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-success btn-lg" onclick="saveCollectorsConfig()">ğŸ’¾ ä¿å­˜é…ç½®å¹¶å®æ—¶ç”Ÿæ•ˆ</button>
                    </div>

                    <!-- è¯´æ˜ -->
                    <div style="margin-top: 30px; padding: 15px; background: #e7f3ff; border-left: 4px solid #007bff; border-radius: 4px;">
                        <h4 style="margin-top: 0;">ğŸ“‹ è¯´æ˜</h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li><strong>å®æ—¶ç”Ÿæ•ˆ</strong>ï¼šé…ç½®ä¿å­˜åç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯åº”ç”¨</li>
                            <li><strong>é‡‡é›†é—´éš”</strong>ï¼šå»ºè®®60ç§’ï¼Œå¤ªé¢‘ç¹ä¼šå¢åŠ æ•°æ®åº“è´Ÿè½½</li>
                            <li><strong>æ…¢SQLé˜ˆå€¼</strong>ï¼šå»ºè®®5ç§’ï¼Œå¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´</li>
                            <li><strong>ç¦ç”¨é‡‡é›†å™¨</strong>ï¼šå°†åœæ­¢åå°å®šæ—¶ä»»åŠ¡ï¼Œä¸ä¼šå†é‡‡é›†æ•°æ®</li>
                            <li><strong>ç³»ç»Ÿè¿‡æ»¤</strong>ï¼šè‡ªåŠ¨è¿‡æ»¤CDCã€å¤åˆ¶ã€sp_server_diagnosticsç­‰ç³»ç»Ÿè¿›ç¨‹</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Config Page -->
        <div id="page-config" class="page">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">æ•°æ®åº“è¿æ¥é…ç½®</span>
                </div>
                <div class="card-body">
                    <div id="configAlert"></div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">æ•°æ®åº“ä¸»æœº</label>
                            <input type="text" class="form-control" id="cfgDbHost" placeholder="192.168.1.100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç«¯å£</label>
                            <input type="number" class="form-control" id="cfgDbPort" value="3306">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ç”¨æˆ·å</label>
                            <input type="text" class="form-control" id="cfgDbUser" placeholder="root">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¯†ç </label>
                            <input type="password" class="form-control" id="cfgDbPassword" placeholder="******">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">æ•°æ®åº“å</label>
                            <input type="text" class="form-control" id="cfgDbName" placeholder="db_monitor">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å­—ç¬¦é›†</label>
                            <input type="text" class="form-control" id="cfgDbCharset" value="utf8mb4">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
                        <button class="btn btn-primary" onclick="saveDbConfig()">ä¿å­˜é…ç½®</button>
                        <button class="btn btn-success" onclick="initDatabase()">åˆå§‹åŒ–æ•°æ®åº“</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">åº”ç”¨é…ç½®</span>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">è‡ªåŠ¨åˆ·æ–°é—´éš”(ç§’)</label>
                            <input type="number" class="form-control" id="cfgRefreshInterval" value="30" min="10" max="300">
                            <div class="form-text">ç›‘æ§é¢æ¿è‡ªåŠ¨åˆ·æ–°çš„æ—¶é—´é—´éš”</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">è­¦å‘Šé˜ˆå€¼(åˆ†é’Ÿ)</label>
                            <input type="number" class="form-control" id="cfgWarningThreshold" value="5" min="1">
                            <div class="form-text">è¶…è¿‡æ­¤æ—¶é—´æ˜¾ç¤ºä¸ºè­¦å‘ŠçŠ¶æ€</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ä¸¥é‡é˜ˆå€¼(åˆ†é’Ÿ)</label>
                            <input type="number" class="form-control" id="cfgCriticalThreshold" value="10" min="1">
                            <div class="form-text">è¶…è¿‡æ­¤æ—¶é—´æ˜¾ç¤ºä¸ºä¸¥é‡çŠ¶æ€</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é»˜è®¤æŸ¥è¯¢æ—¶é—´(å°æ—¶)</label>
                            <input type="number" class="form-control" id="cfgDefaultHours" value="24" min="1" max="168">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveAppConfig()">ä¿å­˜åº”ç”¨é…ç½®</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">å‘Šè­¦é…ç½®</span>
                </div>
                <div class="card-body">
                    <div id="alertConfigAlert"></div>

                    <!-- ä¼ä¸šå¾®ä¿¡é…ç½® -->
                    <h3 style="font-size: 16px; margin-bottom: 15px; color: #667eea;">ä¼ä¸šå¾®ä¿¡å‘Šè­¦</h3>
                    <div class="form-row">
                        <div class="form-group" style="flex: 3;">
                            <label class="form-label">Webhookåœ°å€</label>
                            <input type="text" class="form-control" id="alertWecomWebhook"
                                placeholder="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY">
                            <div class="form-text">ä¼ä¸šå¾®ä¿¡ç¾¤æœºå™¨äºº â†’ æ·»åŠ ç¾¤æœºå™¨äºº â†’ å¤åˆ¶Webhookåœ°å€</div>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">å¯ç”¨</label>
                            <select class="form-control" id="alertWecomEnabled">
                                <option value="true">æ˜¯</option>
                                <option value="false">å¦</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary btn-sm" onclick="testAlert('wecom')">æµ‹è¯•ä¼ä¸šå¾®ä¿¡</button>
                    </div>

                    <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">

                    <!-- é’‰é’‰é…ç½® -->
                    <h3 style="font-size: 16px; margin-bottom: 15px; color: #667eea;">é’‰é’‰å‘Šè­¦ï¼ˆå¯é€‰ï¼‰</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Webhookåœ°å€</label>
                            <input type="text" class="form-control" id="alertDingtalkWebhook"
                                placeholder="https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN">
                        </div>
                        <div class="form-group">
                            <label class="form-label">åŠ ç­¾å¯†é’¥</label>
                            <input type="password" class="form-control" id="alertDingtalkSecret"
                                placeholder="SEC...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¯ç”¨</label>
                            <select class="form-control" id="alertDingtalkEnabled">
                                <option value="true">æ˜¯</option>
                                <option value="false" selected>å¦</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary btn-sm" onclick="testAlert('dingtalk')">æµ‹è¯•é’‰é’‰</button>
                    </div>

                    <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">

                    <!-- å‘Šè­¦è§„åˆ™ -->
                    <h3 style="font-size: 16px; margin-bottom: 15px; color: #667eea;">å‘Šè­¦è§„åˆ™</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">æ…¢SQLå‘Šè­¦é˜ˆå€¼(åˆ†é’Ÿ)</label>
                            <input type="number" class="form-control" id="alertSlowSqlThreshold" value="10" min="1">
                            <div class="form-text">SQLæ‰§è¡Œè¶…è¿‡æ­¤æ—¶é—´æ‰å‘é€å‘Šè­¦</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ­»é”å§‹ç»ˆå‘Šè­¦</label>
                            <select class="form-control" id="alertDeadlockAlways">
                                <option value="true">æ˜¯</option>
                                <option value="false">å¦</option>
                            </select>
                            <div class="form-text">æ£€æµ‹åˆ°æ­»é”ç«‹å³å‘é€å‘Šè­¦</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å‘Šè­¦é—´éš”(ç§’)</label>
                            <input type="number" class="form-control" id="alertInterval" value="300" min="60">
                            <div class="form-text">åŒä¸€é—®é¢˜çš„æœ€å°å‘Šè­¦é—´éš”</div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveAlertConfig()">ä¿å­˜å‘Šè­¦é…ç½®</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SQL Detail Modal -->
    <div id="sqlModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>SQLè¯¦æƒ…</h3>
                <button class="modal-close" onclick="closeSqlModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label class="form-label">æ£€æµ‹æ—¶é—´</label>
                        <div id="modalDetectTime" style="padding: 8px; background: #f8f9fa; border-radius: 4px;">-</div>
                    </div>
                    <div>
                        <label class="form-label">æ‰§è¡Œæ—¶é•¿</label>
                        <div id="modalDuration" style="padding: 8px; background: #f8f9fa; border-radius: 4px;">-</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label class="form-label">é¡¹ç›®/å®ä¾‹</label>
                        <div id="modalInstance" style="padding: 8px; background: #f8f9fa; border-radius: 4px;">-</div>
                    </div>
                    <div>
                        <label class="form-label">æ•°æ®åº“ç±»å‹</label>
                        <div id="modalDbType" style="padding: 8px; background: #f8f9fa; border-radius: 4px;">-</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label class="form-label">ç”¨æˆ·å</label>
                        <div id="modalUser" style="padding: 8px; background: #f8f9fa; border-radius: 4px;">-</div>
                    </div>
                    <div>
                        <label class="form-label">ä¼šè¯ID</label>
                        <div id="modalSession" style="padding: 8px; background: #f8f9fa; border-radius: 4px;">-</div>
                    </div>
                    <div>
                        <label class="form-label">çŠ¶æ€</label>
                        <div id="modalStatus" style="padding: 8px; background: #f8f9fa; border-radius: 4px;">-</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label class="form-label">å®¢æˆ·ç«¯ç¨‹åº</label>
                        <div id="modalProgram" style="padding: 8px; background: #f8f9fa; border-radius: 4px;">-</div>
                    </div>
                    <div>
                        <label class="form-label">å®¢æˆ·ç«¯æœºå™¨</label>
                        <div id="modalMachine" style="padding: 8px; background: #f8f9fa; border-radius: 4px;">-</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px;" id="modalPerformance">
                    <div>
                        <label class="form-label">æ‰«æè¡Œæ•°</label>
                        <div id="modalRowsExamined" style="padding: 8px; background: #fff3cd; border-radius: 4px; font-weight: 600;">-</div>
                    </div>
                    <div>
                        <label class="form-label">è¿”å›è¡Œæ•°</label>
                        <div id="modalRowsSent" style="padding: 8px; background: #d4edda; border-radius: 4px; font-weight: 600;">-</div>
                    </div>
                    <div>
                        <label class="form-label">CPUæ—¶é—´(ç§’)</label>
                        <div id="modalCpuTime" style="padding: 8px; background: #f8d7da; border-radius: 4px; font-weight: 600;">-</div>
                    </div>
                    <div>
                        <label class="form-label">å…¨è¡¨æ‰«æ</label>
                        <div id="modalFullScan" style="padding: 8px; background: #f8d7da; border-radius: 4px; font-weight: 600;">-</div>
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label class="form-label">ä½¿ç”¨çš„ç´¢å¼•</label>
                    <div id="modalIndexUsed" style="padding: 8px; background: #f8f9fa; border-radius: 4px;">-</div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label class="form-label">SQLè¯­å¥</label>
                    <pre id="modalSqlText" style="background: #282c34; color: #abb2bf; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 13px; line-height: 1.6;">-</pre>
                </div>

                <div id="modalExplainSection" style="display: none; margin-bottom: 15px;">
                    <label class="form-label">æ‰§è¡Œè®¡åˆ’</label>
                    <div id="modalExplainPlan" style="background: #f8f9fa; padding: 15px; border-radius: 6px; overflow-x: auto;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="modalKillBtn" onclick="killSession()" style="display: none;">ç»ˆæ­¢ä¼šè¯</button>
                <button class="btn btn-secondary" onclick="closeSqlModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- Instance Edit Modal -->
    <div id="instanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="instanceModalTitle">æ·»åŠ å®ä¾‹</h3>
                <button class="modal-close" onclick="closeInstanceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editInstanceId">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">é¡¹ç›®åç§° *</label>
                        <input type="text" class="form-control" id="instProject" placeholder="ç”Ÿäº§ç¯å¢ƒä¸»åº“">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ•°æ®åº“ç±»å‹</label>
                        <select class="form-control" id="instDbType">
                            <option value="MySQL">MySQL</option>
                            <option value="SQLServer">SQL Server</option>
                            <option value="Oracle">Oracle</option>
                            <option value="PostgreSQL">PostgreSQL</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">IPåœ°å€ *</label>
                        <input type="text" class="form-control" id="instIp" placeholder="192.168.1.100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç«¯å£</label>
                        <input type="number" class="form-control" id="instPort" value="3306">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">å®ä¾‹å/æœåŠ¡å</label>
                        <input type="text" class="form-control" id="instName" placeholder="orcl">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç¯å¢ƒ</label>
                        <select class="form-control" id="instEnv">
                            <option value="production">ç”Ÿäº§ç¯å¢ƒ</option>
                            <option value="staging">é¢„å‘å¸ƒç¯å¢ƒ</option>
                            <option value="development">å¼€å‘ç¯å¢ƒ</option>
                            <option value="test">æµ‹è¯•ç¯å¢ƒ</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">è¿æ¥ç”¨æˆ·å</label>
                        <input type="text" class="form-control" id="instUser" placeholder="monitor">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è¿æ¥å¯†ç </label>
                        <input type="password" class="form-control" id="instPassword" placeholder="******">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">DBAè´Ÿè´£äºº</label>
                        <input type="text" class="form-control" id="instAdmin" placeholder="å¼ ä¸‰">
                    </div>
                    <div class="form-group">
                        <label class="form-label">çŠ¶æ€</label>
                        <select class="form-control" id="instStatus">
                            <option value="1">å¯ç”¨</option>
                            <option value="0">ç¦ç”¨</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">å¤‡æ³¨</label>
                    <textarea class="form-control" id="instDesc" rows="2" placeholder="å®ä¾‹æè¿°ä¿¡æ¯"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeInstanceModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveInstance()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        const API_BASE = '';
        let currentPage = 1;
        let totalPages = 1;
        let deadlockCurrentPage = 1;
        let deadlockTotalPages = 1;
        let autoRefreshTimer = null;
        let isAutoRefresh = false;
        let appConfig = { auto_refresh_interval: 30, warning_threshold: 5, critical_threshold: 10 };
        let instancesData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            updateTime();
            setInterval(updateTime, 1000);
            initNavTabs();

            console.log('[åˆå§‹åŒ–] å¼€å§‹åŠ è½½é¡µé¢æ•°æ®...');

            // å¹¶è¡ŒåŠ è½½æ‰€æœ‰åˆå§‹åŒ–æ•°æ®ï¼Œæ¯ä¸ªPromiseç‹¬ç«‹å¤„ç†é”™è¯¯ï¼Œäº’ä¸å½±å“
            await Promise.allSettled([
                loadConfig().catch(e => console.error('[åˆå§‹åŒ–] loadConfigå¤±è´¥:', e)),
                loadStatistics().catch(e => console.error('[åˆå§‹åŒ–] loadStatisticså¤±è´¥:', e)),
                loadInstancesForFilter().catch(e => console.error('[åˆå§‹åŒ–] loadInstancesForFilterå¤±è´¥:', e)),
                loadPrometheusInstances().catch(e => console.error('[åˆå§‹åŒ–] loadPrometheusInstanceså¤±è´¥:', e)),
                loadPrometheusSqlServerInstances().catch(e => console.error('[åˆå§‹åŒ–] loadPrometheusSqlServerInstanceså¤±è´¥:', e))
            ]);

            // æ— è®ºä¸Šé¢æ˜¯å¦æˆåŠŸï¼Œéƒ½è¦åŠ è½½Long SQLæ•°æ®
            console.log('[åˆå§‹åŒ–] å¼€å§‹åŠ è½½Long SQLåˆ—è¡¨...');
            try {
                await loadLongSQL();
                console.log('[åˆå§‹åŒ–] é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('[åˆå§‹åŒ–] loadLongSQLå¤±è´¥:', error);
                // é”™è¯¯å·²åœ¨loadLongSQLå†…éƒ¨å¤„ç†
            }
        });

        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString('zh-CN');
        }

        // Navigation
        function initNavTabs() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('page-' + this.dataset.page).classList.add('active');

                    // é¡µé¢åˆ‡æ¢æ—¶åŠ è½½å¯¹åº”æ•°æ®
                    if (this.dataset.page === 'performance') loadPerformanceMetrics();
                    if (this.dataset.page === 'realtime') loadRealtimeSQL();
                    if (this.dataset.page === 'deadlock') loadDeadlocks();
                    if (this.dataset.page === 'instances') loadInstances();
                    if (this.dataset.page === 'collectors') loadCollectorsConfig();
                    if (this.dataset.page === 'config') {
                        loadConfig();
                        loadAlertConfig();
                    }
                });
            });
        }

        // API Helper (å¢å¼ºè¶…æ—¶å’Œæ—¥å¿—)
        async function api(endpoint, method = 'GET', data = null) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);  // 30ç§’è¶…æ—¶

                const options = {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    signal: controller.signal
                };

                if (data && method !== 'GET') {
                    options.body = JSON.stringify(data);
                }

                console.log(`[API] ${method} ${endpoint}`);
                const response = await fetch(API_BASE + endpoint, options);
                clearTimeout(timeoutId);

                const result = await response.json();
                console.log(`[API] ${endpoint} - ${result.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
                return result;
            } catch (error) {
                console.error(`[APIé”™è¯¯] ${endpoint}:`, error.message);
                if (error.name === 'AbortError') {
                    return { success: false, error: 'è¯·æ±‚è¶…æ—¶ï¼ˆ30ç§’ï¼‰' };
                }
                return { success: false, error: error.message || 'è¯·æ±‚å¤±è´¥' };
            }
        }

        // Config Management
        async function loadConfig() {
            const result = await api('/api/config');
            if (result.success) {
                const cfg = result.data;
                document.getElementById('cfgDbHost').value = cfg.database?.host || '';
                document.getElementById('cfgDbPort').value = cfg.database?.port || 3306;
                document.getElementById('cfgDbUser').value = cfg.database?.user || '';
                document.getElementById('cfgDbPassword').value = cfg.database?.password || '';
                document.getElementById('cfgDbName').value = cfg.database?.database || '';
                document.getElementById('cfgDbCharset').value = cfg.database?.charset || 'utf8mb4';

                appConfig = cfg.app || appConfig;
                document.getElementById('cfgRefreshInterval').value = appConfig.auto_refresh_interval || 30;
                document.getElementById('cfgWarningThreshold').value = appConfig.warning_threshold || 5;
                document.getElementById('cfgCriticalThreshold').value = appConfig.critical_threshold || 10;
                document.getElementById('cfgDefaultHours').value = appConfig.default_hours || 24;
            }
        }

        async function testConnection() {
            showConfigAlert('info', 'æ­£åœ¨æµ‹è¯•è¿æ¥...');
            const result = await api('/api/config/test', 'POST', {
                host: document.getElementById('cfgDbHost').value,
                port: parseInt(document.getElementById('cfgDbPort').value),
                user: document.getElementById('cfgDbUser').value,
                password: document.getElementById('cfgDbPassword').value,
                database: document.getElementById('cfgDbName').value
            });

            if (result.success) {
                let msg = `è¿æ¥æˆåŠŸ! MySQLç‰ˆæœ¬: ${result.details?.version || 'Unknown'}`;
                if (result.details?.tables_initialized) {
                    msg += ' (æ•°æ®è¡¨å·²åˆå§‹åŒ–)';
                } else {
                    msg += ' (éœ€è¦åˆå§‹åŒ–æ•°æ®è¡¨)';
                }
                showConfigAlert('success', msg);
            } else {
                showConfigAlert('danger', 'è¿æ¥å¤±è´¥: ' + result.error);
            }
        }

        async function saveDbConfig() {
            const result = await api('/api/config', 'POST', {
                database: {
                    host: document.getElementById('cfgDbHost').value,
                    port: parseInt(document.getElementById('cfgDbPort').value),
                    user: document.getElementById('cfgDbUser').value,
                    password: document.getElementById('cfgDbPassword').value,
                    database: document.getElementById('cfgDbName').value,
                    charset: document.getElementById('cfgDbCharset').value
                }
            });

            showConfigAlert(result.success ? 'success' : 'danger', result.message || result.error);
        }

        async function saveAppConfig() {
            const result = await api('/api/config', 'POST', {
                app: {
                    auto_refresh_interval: parseInt(document.getElementById('cfgRefreshInterval').value),
                    warning_threshold: parseInt(document.getElementById('cfgWarningThreshold').value),
                    critical_threshold: parseInt(document.getElementById('cfgCriticalThreshold').value),
                    default_hours: parseInt(document.getElementById('cfgDefaultHours').value)
                }
            });

            if (result.success) {
                appConfig.auto_refresh_interval = parseInt(document.getElementById('cfgRefreshInterval').value);
                appConfig.warning_threshold = parseInt(document.getElementById('cfgWarningThreshold').value);
                appConfig.critical_threshold = parseInt(document.getElementById('cfgCriticalThreshold').value);
            }
            showConfigAlert(result.success ? 'success' : 'danger', result.message || result.error);
        }

        // Collectors Config Functions
        async function loadCollectorsConfig() {
            try {
                const result = await api('/api/collectors/config');
                if (result.success) {
                    const mysql = result.data.mysql || {};
                    const sqlserver = result.data.sqlserver || {};

                    // MySQLé…ç½®
                    document.getElementById('mysqlEnabled').value = String(mysql.enabled !== false);
                    document.getElementById('mysqlInterval').value = mysql.interval || 60;
                    document.getElementById('mysqlThreshold').value = mysql.threshold || 5;
                    document.getElementById('mysqlStatus').textContent = mysql.status === 'running' ? 'âœ… è¿è¡Œä¸­' : 'â¸ï¸ å·²åœæ­¢';
                    document.getElementById('mysqlStatus').style.color = mysql.status === 'running' ? '#28a745' : '#dc3545';
                    document.getElementById('mysqlNextRun').textContent = mysql.next_run || '-';

                    // SQL Serveré…ç½®
                    document.getElementById('sqlserverEnabled').value = String(sqlserver.enabled !== false);
                    document.getElementById('sqlserverInterval').value = sqlserver.interval || 60;
                    document.getElementById('sqlserverThreshold').value = sqlserver.threshold || 5;
                    document.getElementById('sqlserverAutoEnable').value = String(sqlserver.auto_enable_querystore === true);
                    document.getElementById('sqlserverStatus').textContent = sqlserver.status === 'running' ? 'âœ… è¿è¡Œä¸­' : 'â¸ï¸ å·²åœæ­¢';
                    document.getElementById('sqlserverStatus').style.color = sqlserver.status === 'running' ? '#28a745' : '#dc3545';
                    document.getElementById('sqlserverNextRun').textContent = sqlserver.next_run || '-';

                    showCollectorsAlert('success', 'é…ç½®åŠ è½½æˆåŠŸ');
                } else {
                    showCollectorsAlert('danger', 'é…ç½®åŠ è½½å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                console.error('åŠ è½½é‡‡é›†å™¨é…ç½®å¤±è´¥:', error);
                showCollectorsAlert('danger', 'åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        async function saveCollectorsConfig() {
            try {
                const config = {
                    mysql: {
                        enabled: document.getElementById('mysqlEnabled').value === 'true',
                        interval: parseInt(document.getElementById('mysqlInterval').value),
                        threshold: parseInt(document.getElementById('mysqlThreshold').value)
                    },
                    sqlserver: {
                        enabled: document.getElementById('sqlserverEnabled').value === 'true',
                        interval: parseInt(document.getElementById('sqlserverInterval').value),
                        threshold: parseInt(document.getElementById('sqlserverThreshold').value),
                        auto_enable_querystore: document.getElementById('sqlserverAutoEnable').value === 'true'
                    }
                };

                // éªŒè¯è¾“å…¥
                if (config.mysql.interval < 10 || config.mysql.interval > 3600) {
                    showCollectorsAlert('danger', 'MySQLé‡‡é›†é—´éš”å¿…é¡»åœ¨10-3600ç§’ä¹‹é—´');
                    return;
                }
                if (config.sqlserver.interval < 10 || config.sqlserver.interval > 3600) {
                    showCollectorsAlert('danger', 'SQL Serveré‡‡é›†é—´éš”å¿…é¡»åœ¨10-3600ç§’ä¹‹é—´');
                    return;
                }
                if (config.mysql.threshold < 1 || config.mysql.threshold > 3600) {
                    showCollectorsAlert('danger', 'MySQLæ…¢SQLé˜ˆå€¼å¿…é¡»åœ¨1-3600ç§’ä¹‹é—´');
                    return;
                }
                if (config.sqlserver.threshold < 1 || config.sqlserver.threshold > 3600) {
                    showCollectorsAlert('danger', 'SQL Serveræ…¢SQLé˜ˆå€¼å¿…é¡»åœ¨1-3600ç§’ä¹‹é—´');
                    return;
                }

                showCollectorsAlert('info', 'æ­£åœ¨ä¿å­˜é…ç½®å¹¶æ›´æ–°è°ƒåº¦å™¨...');

                const result = await api('/api/collectors/config', 'POST', config);

                if (result.success) {
                    showCollectorsAlert('success', 'âœ… ' + result.message);
                    // é‡æ–°åŠ è½½é…ç½®æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
                    setTimeout(() => loadCollectorsConfig(), 1000);
                } else {
                    showCollectorsAlert('danger', 'ä¿å­˜å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                console.error('ä¿å­˜é‡‡é›†å™¨é…ç½®å¤±è´¥:', error);
                showCollectorsAlert('danger', 'ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        async function triggerCollector(type) {
            try {
                showCollectorsAlert('info', `æ­£åœ¨æ‰‹åŠ¨æ‰§è¡Œ${type === 'mysql' ? 'MySQL' : 'SQL Server'}é‡‡é›†å™¨...`);

                const result = await api(`/api/collectors/${type}/trigger`, 'POST');

                if (result.success) {
                    showCollectorsAlert('success', 'âœ… ' + result.message);
                    // åˆ·æ–°çŠ¶æ€
                    setTimeout(() => loadCollectorsConfig(), 1000);
                } else {
                    showCollectorsAlert('danger', 'æ‰§è¡Œå¤±è´¥: ' + result.error);
                }
            } catch (error) {
                console.error('æ‰‹åŠ¨è§¦å‘é‡‡é›†å™¨å¤±è´¥:', error);
                showCollectorsAlert('danger', 'æ‰§è¡Œå¤±è´¥: ' + error.message);
            }
        }

        function showCollectorsAlert(type, message) {
            const alertDiv = document.getElementById('collectorsAlert');
            const alertClass = type === 'success' ? 'alert-success' : type === 'danger' ? 'alert-danger' : 'alert-info';
            alertDiv.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            setTimeout(() => { alertDiv.innerHTML = ''; }, 5000);
        }

        // Alert Config Functions
        async function loadAlertConfig() {
            const result = await api('/api/alert-config');
            if (result.success) {
                const cfg = result.data;

                // ä¼ä¸šå¾®ä¿¡
                document.getElementById('alertWecomWebhook').value = cfg.wecom?.webhook || '';
                document.getElementById('alertWecomEnabled').value = cfg.wecom?.enabled ? 'true' : 'false';

                // é’‰é’‰
                document.getElementById('alertDingtalkWebhook').value = cfg.dingtalk?.webhook || '';
                document.getElementById('alertDingtalkSecret').value = cfg.dingtalk?.secret || '';
                document.getElementById('alertDingtalkEnabled').value = cfg.dingtalk?.enabled ? 'true' : 'false';

                // å‘Šè­¦è§„åˆ™
                document.getElementById('alertSlowSqlThreshold').value = cfg.alert_rules?.slow_sql_threshold_minutes || 10;
                document.getElementById('alertDeadlockAlways').value = cfg.alert_rules?.deadlock_always_alert ? 'true' : 'false';
                document.getElementById('alertInterval').value = cfg.alert_rules?.alert_interval_seconds || 300;
            }
        }

        async function saveAlertConfig() {
            const data = {
                wecom: {
                    webhook: document.getElementById('alertWecomWebhook').value.trim(),
                    enabled: document.getElementById('alertWecomEnabled').value === 'true'
                },
                dingtalk: {
                    webhook: document.getElementById('alertDingtalkWebhook').value.trim(),
                    secret: document.getElementById('alertDingtalkSecret').value.trim(),
                    enabled: document.getElementById('alertDingtalkEnabled').value === 'true'
                },
                alert_rules: {
                    slow_sql_threshold_minutes: parseInt(document.getElementById('alertSlowSqlThreshold').value),
                    deadlock_always_alert: document.getElementById('alertDeadlockAlways').value === 'true',
                    alert_interval_seconds: parseInt(document.getElementById('alertInterval').value)
                }
            };

            const result = await api('/api/alert-config', 'POST', data);

            showAlertConfigAlert(result.success ? 'success' : 'danger', result.message || result.error);
        }

        async function testAlert(channel) {
            showAlertConfigAlert('info', `æ­£åœ¨å‘é€${channel}æµ‹è¯•æ¶ˆæ¯...`);

            const result = await api('/api/alert-config/test', 'POST', { channel: channel });

            if (result.success) {
                showAlertConfigAlert('success', result.message + ' - è¯·æ£€æŸ¥æ‚¨çš„æ¶ˆæ¯æ¥æ”¶ç«¯');
            } else {
                showAlertConfigAlert('danger', 'æµ‹è¯•å¤±è´¥: ' + result.error);
            }
        }

        function showAlertConfigAlert(type, message) {
            const alertDiv = document.getElementById('alertConfigAlert');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertDiv.innerHTML = '', 5000);
        }

        async function initDatabase() {
            if (!confirm('ç¡®å®šè¦åˆå§‹åŒ–æ•°æ®åº“è¡¨å—?è¿™å°†åˆ›å»ºå¿…è¦çš„è¡¨ç»“æ„ã€‚')) return;

            showConfigAlert('info', 'æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“...');
            const result = await api('/api/config/init-db', 'POST');
            showConfigAlert(result.success ? 'success' : 'danger', result.message || result.error);
        }

        function showConfigAlert(type, message) {
            const alertDiv = document.getElementById('configAlert');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertDiv.innerHTML = '', 5000);
        }

        // Statistics
        async function loadStatistics() {
            const hours = document.getElementById('filterHours').value;
            const result = await api(`/api/statistics?hours=${hours}`);

            if (result.success) {
                const s = result.summary || {};
                document.getElementById('stat-instances').textContent = s.instance_count || 0;
                document.getElementById('stat-total').textContent = s.total_sql_count || 0;
                const avgDuration = parseFloat(s.avg_duration) || 0;
                document.getElementById('stat-avg').innerHTML = avgDuration.toFixed(1) + '<small>åˆ†é’Ÿ</small>';
                document.getElementById('stat-deadlock').textContent = s.deadlock_count || 0;

                renderInstanceChart(result.instances || []);
                renderTrendChart(result.trend || []);
            }
        }

        // Charts
        function renderInstanceChart(data) {
            const canvas = document.getElementById('instanceChart');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (!data.length) {
                ctx.fillStyle = '#999';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— æ•°æ®', canvas.width / 2, canvas.height / 2);
                return;
            }

            const maxCount = Math.max(...data.map(d => d.sql_count || 0), 1);
            const barWidth = Math.min(40, (canvas.width - 60) / data.length - 10);
            const startX = 50;
            const chartHeight = canvas.height - 60;

            data.slice(0, 10).forEach((d, i) => {
                const height = ((d.sql_count || 0) / maxCount) * chartHeight;
                const x = startX + i * (barWidth + 10);
                const y = canvas.height - 40 - height;

                const gradient = ctx.createLinearGradient(x, y, x, canvas.height - 40);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, barWidth, height);

                ctx.fillStyle = '#666';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'center';
                ctx.save();
                ctx.translate(x + barWidth / 2, canvas.height - 25);
                ctx.rotate(-Math.PI / 6);
                ctx.fillText((d.db_ip || '').substring(0, 12), 0, 0);
                ctx.restore();

                ctx.fillStyle = '#333';
                ctx.fillText(d.sql_count || 0, x + barWidth / 2, y - 5);
            });
        }

        function renderTrendChart(data) {
            const canvas = document.getElementById('trendChart');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (!data.length) {
                ctx.fillStyle = '#999';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— æ•°æ®', canvas.width / 2, canvas.height / 2);
                return;
            }

            const maxCount = Math.max(...data.map(d => d.sql_count || 0), 1);
            const chartWidth = canvas.width - 80;
            const chartHeight = canvas.height - 60;
            const startX = 50;
            const startY = 20;

            ctx.beginPath();
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;

            data.forEach((d, i) => {
                const x = startX + (i / (data.length - 1 || 1)) * chartWidth;
                const y = startY + chartHeight - ((d.sql_count || 0) / maxCount) * chartHeight;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();

            // Fill area
            ctx.lineTo(startX + chartWidth, startY + chartHeight);
            ctx.lineTo(startX, startY + chartHeight);
            ctx.closePath();
            ctx.fillStyle = 'rgba(102, 126, 234, 0.1)';
            ctx.fill();

            // Points
            data.forEach((d, i) => {
                const x = startX + (i / (data.length - 1 || 1)) * chartWidth;
                const y = startY + chartHeight - ((d.sql_count || 0) / maxCount) * chartHeight;
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fillStyle = '#667eea';
                ctx.fill();
            });

            // X-axis labels
            ctx.fillStyle = '#666';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            const step = Math.ceil(data.length / 6);
            data.forEach((d, i) => {
                if (i % step === 0) {
                    const x = startX + (i / (data.length - 1 || 1)) * chartWidth;
                    const label = (d.hour_time || '').substring(11, 16);
                    ctx.fillText(label, x, canvas.height - 10);
                }
            });
        }

        // Long SQL Data (å¢å¼ºé”™è¯¯å¤„ç†)
        async function loadLongSQL() {
            const tbody = document.getElementById('sqlTableBody');
            try {
                const hours = document.getElementById('filterHours').value;
                const instanceId = document.getElementById('filterInstance').value;
                const minMinutes = document.getElementById('filterMinMinutes').value;
                const pageSize = document.getElementById('filterPageSize').value;

                let url = `/api/long_sql?hours=${hours}&min_minutes=${minMinutes}&page=${currentPage}&page_size=${pageSize}`;
                if (instanceId) url += `&instance_id=${instanceId}`;

                console.log('[Long SQL] å¼€å§‹åŠ è½½æ•°æ®...');
                const result = await api(url);

                if (!result || !result.success) {
                    const errorMsg = result?.error || 'æœªçŸ¥é”™è¯¯';
                    console.error('[Long SQL] åŠ è½½å¤±è´¥:', errorMsg);
                    tbody.innerHTML = `<tr><td colspan="7" class="empty-state">åŠ è½½å¤±è´¥: ${errorMsg}<br><button class="btn btn-primary" onclick="loadLongSQL()">é‡è¯•</button></td></tr>`;
                    return;
                }

                console.log('[Long SQL] åŠ è½½æˆåŠŸï¼Œæ•°æ®é‡:', result.data?.length || 0);

                // å¤„ç†æ•°æ®ï¼ˆå¿…é¡»åœ¨tryå—å†…ï¼Œresultå˜é‡åœ¨ä½œç”¨åŸŸå†…ï¼‰
                const data = result.data || [];
                const pagination = result.pagination || {};
                totalPages = pagination.total_pages || 1;

                document.getElementById('pageInfo').textContent = `ç¬¬ ${pagination.current_page || 1} é¡µ / å…± ${totalPages} é¡µ (${pagination.total_count || 0}æ¡)`;
                document.getElementById('prevPage').disabled = !pagination.has_prev;
                document.getElementById('nextPage').disabled = !pagination.has_next;

                if (!data.length) {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">æš‚æ— æ•°æ®</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map((row, idx) => {
                    const minutes = parseFloat(row.elapsed_minutes) || 0;
                    let badgeClass = 'badge-success';
                    if (minutes > appConfig.critical_threshold) badgeClass = 'badge-danger';
                    else if (minutes > appConfig.warning_threshold) badgeClass = 'badge-warning';

                    const sqlText = row.sql_text || '';
                    const sqlPreview = sqlText.substring(0, 150) + (sqlText.length > 150 ? '...' : '');
                    const fullSql = escapeHtml(sqlText);

                    return `<tr>
                        <td>${row.detect_time || '-'}</td>
                        <td>${row.db_project || '-'}<br><small style="color:#888">${row.db_ip || ''}:${row.db_port || ''}</small></td>
                        <td>${row.username || '-'}</td>
                        <td><span class="badge ${badgeClass}">${minutes.toFixed(2)} åˆ†é’Ÿ</span></td>
                        <td>${row.status || '-'}</td>
                        <td>
                            <code style="font-size:11px;cursor:pointer;display:block;max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"
                                  onclick="showFullSQL('${fullSql.replace(/'/g, "&#39;")}')"
                                  title="ç‚¹å‡»æŸ¥çœ‹å®Œæ•´SQL">${escapeHtml(sqlPreview)}</code>
                        </td>
                        <td><button class="btn btn-sm btn-primary" onclick='showSqlDetail(${JSON.stringify(row).replace(/'/g, "&#39;")})'>è¯¦æƒ…</button></td>
                    </tr>`;
                }).join('');

                loadStatistics();
            } catch (error) {
                console.error('[Long SQL] å¼‚å¸¸:', error);
                tbody.innerHTML = `<tr><td colspan="7" class="empty-state">åŠ è½½å¼‚å¸¸: ${error.message}<br><button class="btn btn-primary" onclick="loadLongSQL()">é‡è¯•</button></td></tr>`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function changePage(delta) {
            currentPage = Math.max(1, Math.min(totalPages, currentPage + delta));
            loadLongSQL();
        }

        function toggleAutoRefresh() {
            isAutoRefresh = !isAutoRefresh;
            document.getElementById('autoRefreshIcon').textContent = isAutoRefresh ? 'â¸' : 'â–¶';

            if (isAutoRefresh) {
                autoRefreshTimer = setInterval(() => {
                    loadLongSQL();
                }, (appConfig.auto_refresh_interval || 30) * 1000);
            } else {
                clearInterval(autoRefreshTimer);
            }
        }

        // SQL Detail Modal
        let currentSqlDetail = null;

        async function showSqlDetail(row) {
            // å¦‚æœrowåªæœ‰idï¼Œè°ƒç”¨APIè·å–å®Œæ•´è¯¦æƒ…
            const sqlId = row.id;

            try {
                const result = await api(`/api/long_sql/${sqlId}`);
                if (!result.success) {
                    alert('è·å–SQLè¯¦æƒ…å¤±è´¥: ' + result.error);
                    return;
                }

                const data = result.data;
                currentSqlDetail = data;

                // åŸºæœ¬ä¿¡æ¯
                document.getElementById('modalDetectTime').textContent = data.detect_time || '-';
                document.getElementById('modalDuration').textContent = (parseFloat(data.elapsed_minutes) || 0).toFixed(2) + ' åˆ†é’Ÿ';
                document.getElementById('modalInstance').textContent = `${data.db_project || '-'} (${data.db_ip || ''}:${data.db_port || ''})`;
                document.getElementById('modalDbType').textContent = data.db_type || '-';
                document.getElementById('modalUser').textContent = data.username || '-';
                document.getElementById('modalSession').textContent = data.session_id || '-';
                document.getElementById('modalStatus').textContent = data.status || '-';
                document.getElementById('modalProgram').textContent = data.program || '-';
                document.getElementById('modalMachine').textContent = data.machine || '-';

                // æ€§èƒ½æŒ‡æ ‡
                document.getElementById('modalRowsExamined').textContent = data.rows_examined ? formatNumber(data.rows_examined) : '-';
                document.getElementById('modalRowsSent').textContent = data.rows_sent ? formatNumber(data.rows_sent) : '-';
                document.getElementById('modalCpuTime').textContent = data.cpu_time ? parseFloat(data.cpu_time).toFixed(2) : '-';
                document.getElementById('modalFullScan').textContent = data.full_table_scan ? 'æ˜¯' : 'å¦';

                // ç´¢å¼•ä¿¡æ¯
                document.getElementById('modalIndexUsed').textContent = data.index_used || 'æœªä½¿ç”¨ç´¢å¼•';

                // SQLæ–‡æœ¬ï¼ˆä¼˜å…ˆæ˜¾ç¤ºå®Œæ•´æ–‡æœ¬ï¼‰
                document.getElementById('modalSqlText').textContent = data.sql_fulltext || data.sql_text || '-';

                // æ‰§è¡Œè®¡åˆ’
                const explainSection = document.getElementById('modalExplainSection');
                const explainPlan = document.getElementById('modalExplainPlan');
                if (data.execution_plan) {
                    try {
                        const plan = typeof data.execution_plan === 'string' ? JSON.parse(data.execution_plan) : data.execution_plan;
                        explainPlan.innerHTML = formatExecutionPlan(plan);
                        explainSection.style.display = 'block';
                    } catch (e) {
                        explainSection.style.display = 'none';
                    }
                } else {
                    explainSection.style.display = 'none';
                }

                // KillæŒ‰é’®ï¼ˆåªæœ‰ACTIVEçŠ¶æ€æ‰æ˜¾ç¤ºï¼‰
                const killBtn = document.getElementById('modalKillBtn');
                if (data.status === 'ACTIVE' && data.session_id) {
                    killBtn.style.display = 'inline-flex';
                } else {
                    killBtn.style.display = 'none';
                }

                document.getElementById('sqlModal').classList.add('show');
            } catch (error) {
                alert('è·å–SQLè¯¦æƒ…å¤±è´¥: ' + error.message);
            }
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function formatExecutionPlan(plan) {
            if (Array.isArray(plan)) {
                // MySQL EXPLAIN æ ¼å¼
                let html = '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
                html += '<thead><tr style="background: #667eea; color: white;">';
                const keys = Object.keys(plan[0] || {});
                keys.forEach(key => {
                    html += `<th style="padding: 8px; border: 1px solid #ddd;">${key}</th>`;
                });
                html += '</tr></thead><tbody>';

                plan.forEach(row => {
                    html += '<tr>';
                    keys.forEach(key => {
                        const value = row[key] !== null && row[key] !== undefined ? row[key] : '-';
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${value}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';
                return html;
            } else {
                return `<pre style="margin: 0;">${JSON.stringify(plan, null, 2)}</pre>`;
            }
        }

        async function killSession() {
            if (!currentSqlDetail) return;

            const sessionId = currentSqlDetail.session_id;
            const instanceId = currentSqlDetail.db_instance_id;
            const dbType = currentSqlDetail.db_type || 'MySQL';

            if (!confirm(`ç¡®å®šè¦ç»ˆæ­¢ä¼šè¯ ${sessionId} å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }

            try {
                const result = await api('/api/kill_session', 'POST', {
                    instance_id: instanceId,
                    session_id: sessionId,
                    db_type: dbType
                });

                if (result.success) {
                    alert('âœ“ ' + result.message);
                    closeSqlModal();
                    loadLongSQL(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert('âœ— ç»ˆæ­¢å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('âœ— ç»ˆæ­¢å¤±è´¥: ' + error.message);
            }
        }

        function closeSqlModal() {
            document.getElementById('sqlModal').classList.remove('show');
            currentSqlDetail = null;
        }

        // Instances Management
        async function loadInstances() {
            const result = await api('/api/instances');
            const tbody = document.getElementById('instancesTableBody');

            if (!result.success) {
                tbody.innerHTML = `<tr><td colspan="10" class="empty-state">åŠ è½½å¤±è´¥: ${result.error}</td></tr>`;
                return;
            }

            instancesData = result.data || [];
            if (!instancesData.length) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty-state">æš‚æ— å®ä¾‹æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = instancesData.map(row => `<tr>
                <td>${row.id}</td>
                <td>${row.db_project || '-'}</td>
                <td>${row.db_ip || '-'}</td>
                <td>${row.db_port || '-'}</td>
                <td>${row.instance_name || '-'}</td>
                <td><span class="badge badge-primary">${row.db_type || 'MySQL'}</span></td>
                <td>${row.db_user || '-'}</td>
                <td>${row.environment || '-'}</td>
                <td><span class="status-dot ${row.status == 1 ? 'online' : 'offline'}"></span>${row.status == 1 ? 'å¯ç”¨' : 'ç¦ç”¨'}</td>
                <td class="actions">
                    <button class="action-btn test" onclick="testInstanceConnection(${row.id})">æµ‹è¯•</button>
                    <button class="action-btn edit" onclick="editInstance(${row.id})">ç¼–è¾‘</button>
                    <button class="action-btn delete" onclick="deleteInstance(${row.id})">åˆ é™¤</button>
                </td>
            </tr>`).join('');
        }

        async function loadInstancesForFilter() {
            const result = await api('/api/instances');
            if (result.success) {
                const select = document.getElementById('filterInstance');
                select.innerHTML = '<option value="">å…¨éƒ¨å®ä¾‹</option>' +
                    (result.data || []).map(i => `<option value="${i.id}">${i.db_project} (${i.db_ip})</option>`).join('');
            }
        }

        function showInstanceModal(instance = null) {
            document.getElementById('instanceModalTitle').textContent = instance ? 'ç¼–è¾‘å®ä¾‹' : 'æ·»åŠ å®ä¾‹';
            document.getElementById('editInstanceId').value = instance?.id || '';
            document.getElementById('instProject').value = instance?.db_project || '';
            document.getElementById('instDbType').value = instance?.db_type || 'MySQL';
            document.getElementById('instIp').value = instance?.db_ip || '';

            // æ ¹æ®æ•°æ®åº“ç±»å‹è®¾ç½®é»˜è®¤ç«¯å£
            let defaultPort = 3306;
            if (instance?.db_port) {
                defaultPort = instance.db_port;
            } else {
                const dbType = instance?.db_type || 'MySQL';
                defaultPort = getDefaultPort(dbType);
            }
            document.getElementById('instPort').value = defaultPort;

            document.getElementById('instName').value = instance?.instance_name || '';
            document.getElementById('instEnv').value = instance?.environment || 'production';
            document.getElementById('instUser').value = instance?.db_user || '';
            document.getElementById('instPassword').value = '';
            document.getElementById('instAdmin').value = instance?.db_admin || '';
            document.getElementById('instStatus').value = instance?.status ?? 1;
            document.getElementById('instDesc').value = instance?.description || '';

            // ç»‘å®šæ•°æ®åº“ç±»å‹æ”¹å˜äº‹ä»¶
            const dbTypeSelect = document.getElementById('instDbType');
            dbTypeSelect.onchange = function() {
                if (!instance) {  // åªåœ¨æ–°å¢æ—¶è‡ªåŠ¨æ›´æ”¹ç«¯å£
                    document.getElementById('instPort').value = getDefaultPort(this.value);
                }
            };

            document.getElementById('instanceModal').classList.add('show');
        }

        function getDefaultPort(dbType) {
            const portMap = {
                'MySQL': 3306,
                'SQLServer': 1433,
                'Oracle': 1521,
                'PostgreSQL': 5432
            };
            return portMap[dbType] || 3306;
        }

        function closeInstanceModal() {
            document.getElementById('instanceModal').classList.remove('show');
        }

        function editInstance(id) {
            const instance = instancesData.find(i => i.id === id);
            if (instance) showInstanceModal(instance);
        }

        async function saveInstance() {
            const id = document.getElementById('editInstanceId').value;
            const data = {
                db_project: document.getElementById('instProject').value,
                db_type: document.getElementById('instDbType').value,
                db_ip: document.getElementById('instIp').value,
                db_port: parseInt(document.getElementById('instPort').value),
                instance_name: document.getElementById('instName').value,
                environment: document.getElementById('instEnv').value,
                db_user: document.getElementById('instUser').value,
                db_admin: document.getElementById('instAdmin').value,
                status: parseInt(document.getElementById('instStatus').value),
                description: document.getElementById('instDesc').value
            };

            const password = document.getElementById('instPassword').value;
            if (password) data.db_password = password;

            if (!data.db_project || !data.db_ip) {
                alert('è¯·å¡«å†™é¡¹ç›®åç§°å’ŒIPåœ°å€');
                return;
            }

            const result = await api(id ? `/api/instances/${id}` : '/api/instances', id ? 'PUT' : 'POST', data);

            if (result.success) {
                closeInstanceModal();
                loadInstances();
                loadInstancesForFilter();
                showInstancesAlert('success', result.message);
            } else {
                showInstancesAlert('danger', result.error);
            }
        }

        async function testInstanceConnection(id) {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'æµ‹è¯•ä¸­...';

            const result = await api(`/api/instances/${id}/test`, 'POST');

            btn.disabled = false;
            btn.textContent = 'æµ‹è¯•';

            if (result.success) {
                const msg = result.details?.version
                    ? `${result.message} - ç‰ˆæœ¬: ${result.details.version}`
                    : result.message;
                showInstancesAlert('success', msg);
            } else {
                showInstancesAlert('danger', 'è¿æ¥å¤±è´¥: ' + result.error);
            }
        }

        async function deleteInstance(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å®ä¾‹å—?ç›¸å…³çš„SQLæ—¥å¿—ä¹Ÿä¼šè¢«åˆ é™¤ã€‚')) return;

            const result = await api(`/api/instances/${id}`, 'DELETE');
            if (result.success) {
                loadInstances();
                loadInstancesForFilter();
                showInstancesAlert('success', result.message);
            } else {
                showInstancesAlert('danger', result.error);
            }
        }

        function showInstancesAlert(type, message) {
            const alertDiv = document.getElementById('instancesAlert');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertDiv.innerHTML = '', 3000);
        }

        // Realtime Monitoring Functions
        let realtimeRefreshTimer = null;
        let isRealtimeAutoRefresh = false;

        async function loadRealtimeSQL() {
            const instanceId = document.getElementById('realtimeFilterInstance').value;
            const minSeconds = parseInt(document.getElementById('realtimeMinSeconds').value) || 0;

            let url = `/api/realtime_sql?min_seconds=${minSeconds}`;
            if (instanceId) url += `&instance_id=${instanceId}`;

            try {
                const result = await api(url);
                const tbody = document.getElementById('realtimeTableBody');

                if (!result.success) {
                    tbody.innerHTML = `<tr><td colspan="7" class="empty-state">åŠ è½½å¤±è´¥: ${result.error}</td></tr>`;
                    return;
                }

                const data = result.data || [];
                const stats = result.stats || {};

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                document.getElementById('realtimeCount').textContent = stats.total_count || 0;
                document.getElementById('realtimeMax').innerHTML = (stats.max_seconds || 0) + '<small>ç§’</small>';
                document.getElementById('realtimeBlocked').textContent = stats.blocked_count || 0;

                // åŠ è½½å®ä¾‹è¿‡æ»¤å™¨
                if (document.getElementById('realtimeFilterInstance').options.length === 1) {
                    const instances = await api('/api/instances');
                    if (instances.success) {
                        document.getElementById('realtimeFilterInstance').innerHTML = '<option value="">å…¨éƒ¨å®ä¾‹</option>' +
                            (instances.data || []).map(i => `<option value="${i.id}">${i.db_project} (${i.db_ip})</option>`).join('');
                    }
                }

                if (!data.length) {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">å½“å‰æ²¡æœ‰è¿è¡Œä¸­çš„SQL</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(row => {
                    const seconds = parseFloat(row.elapsed_seconds) || 0;
                    let badgeClass = 'badge-success';
                    if (seconds > 60) badgeClass = 'badge-danger';
                    else if (seconds > 30) badgeClass = 'badge-warning';

                    const sqlText = row.sql_text || '';
                    const sqlPreview = sqlText.substring(0, 150) + (sqlText.length > 150 ? '...' : '');
                    const fullSql = escapeHtml(sqlText);

                    const dbName = row.database_name ? `<br><small style="color:#4CAF50;font-weight:500">ğŸ“ ${row.database_name}</small>` : '';
                    return `<tr style="cursor:pointer;" ondblclick='showRealtimeSqlDetail(${JSON.stringify(row).replace(/'/g, "&#39;")})' title="åŒå‡»æŸ¥çœ‹è¯¦æƒ…">
                        <td>${row.session_id || '-'}</td>
                        <td>${row.db_project || '-'}<br><small style="color:#888">${row.db_ip || ''}:${row.db_port || ''}</small></td>
                        <td>${row.username || '-'}<br><small style="color:#888">${row.machine || ''}</small>${dbName}</td>
                        <td><span class="badge ${badgeClass}">${seconds} ç§’</span></td>
                        <td><span class="badge badge-primary">${row.status || 'ACTIVE'}</span></td>
                        <td>
                            <code style="font-size:11px;cursor:pointer;display:block;max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"
                                  onclick="event.stopPropagation();showFullSQL('${fullSql.replace(/'/g, "&#39;")}')"
                                  title="ç‚¹å‡»æŸ¥çœ‹å®Œæ•´SQL">${escapeHtml(sqlPreview)}</code>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick='event.stopPropagation();killRealtimeSession(${JSON.stringify(row).replace(/'/g, "&#39;")})'>Kill</button>
                        </td>
                    </tr>`;
                }).join('');

            } catch (error) {
                document.getElementById('realtimeTableBody').innerHTML =
                    `<tr><td colspan="7" class="empty-state">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
            }
        }

        async function killRealtimeSession(row) {
            if (!confirm(`ç¡®å®šè¦ç»ˆæ­¢ä¼šè¯ ${row.session_id} å—ï¼Ÿ\n\nç”¨æˆ·: ${row.username}\nSQL: ${row.sql_text.substring(0, 100)}\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }

            try {
                const result = await api('/api/kill_session', 'POST', {
                    instance_id: row.db_instance_id,
                    session_id: row.session_id,
                    db_type: row.db_type || 'MySQL'
                });

                if (result.success) {
                    alert('âœ“ ' + result.message);
                    loadRealtimeSQL(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert('âœ— ç»ˆæ­¢å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('âœ— ç»ˆæ­¢å¤±è´¥: ' + error.message);
            }
        }

        function toggleRealtimeRefresh() {
            isRealtimeAutoRefresh = !isRealtimeAutoRefresh;
            document.getElementById('realtimeRefreshIcon').textContent = isRealtimeAutoRefresh ? 'â¸' : 'â–¶';

            if (isRealtimeAutoRefresh) {
                loadRealtimeSQL(); // ç«‹å³åŠ è½½ä¸€æ¬¡
                realtimeRefreshTimer = setInterval(() => {
                    loadRealtimeSQL();
                }, 5000); // æ¯5ç§’åˆ·æ–°
            } else {
                clearInterval(realtimeRefreshTimer);
            }
        }

        function showFullSQL(sqlText) {
            // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºå®Œæ•´SQL
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
                    <div class="modal-header">
                        <h3>å®Œæ•´SQLè¯­å¥</h3>
                        <button class="btn btn-sm" onclick="this.closest('.modal').remove()" style="font-size:20px;padding:0 10px;">&times;</button>
                    </div>
                    <div class="modal-body" style="overflow-y: auto;">
                        <pre style="background:#f5f5f5;padding:15px;border-radius:4px;overflow-x:auto;max-height:60vh;margin:0;"><code>${sqlText}</code></pre>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="navigator.clipboard.writeText(\`${sqlText.replace(/`/g, '\\`')}\`).then(() => alert('SQLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))">å¤åˆ¶SQL</button>
                        <button class="btn btn-primary" onclick="this.closest('.modal').remove()">å…³é—­</button>
                    </div>
                </div>
            `;

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);
        }

        function showRealtimeSqlDetail(row) {
            // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºå®æ—¶SQLè¯¦æƒ…
            const seconds = parseFloat(row.elapsed_seconds) || 0;
            let durationClass = 'badge-success';
            if (seconds > 60) durationClass = 'badge-danger';
            else if (seconds > 30) durationClass = 'badge-warning';

            const sqlText = escapeHtml(row.sql_text || 'æ— SQLè¯­å¥');

            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 1000px; max-height: 85vh;">
                    <div class="modal-header">
                        <h3>å®æ—¶SQLè¯¦æƒ… - ä¼šè¯ ${row.session_id}</h3>
                        <button class="btn btn-sm" onclick="this.closest('.modal').remove()" style="font-size:20px;padding:0 10px;">&times;</button>
                    </div>
                    <div class="modal-body" style="overflow-y: auto;">
                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                            <div class="info-card">
                                <h4 style="margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 5px;">
                                    <span style="color: #4CAF50;">ğŸ“Š</span> åŸºæœ¬ä¿¡æ¯
                                </h4>
                                <div class="info-row">
                                    <span class="info-label">ä¼šè¯ID:</span>
                                    <span class="info-value"><strong>${row.session_id || '-'}</strong></span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">å®ä¾‹:</span>
                                    <span class="info-value">${row.db_project || '-'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">åœ°å€:</span>
                                    <span class="info-value">${row.db_ip || '-'}:${row.db_port || '-'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">æ•°æ®åº“ç±»å‹:</span>
                                    <span class="info-value"><span class="badge badge-primary">${row.db_type || 'MySQL'}</span></span>
                                </div>
                                ${row.database_name ? `
                                <div class="info-row">
                                    <span class="info-label">æ•°æ®åº“:</span>
                                    <span class="info-value"><span class="badge badge-success">${row.database_name}</span></span>
                                </div>
                                ` : ''}
                            </div>
                            <div class="info-card">
                                <h4 style="margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #2196F3; padding-bottom: 5px;">
                                    <span style="color: #2196F3;">ğŸ‘¤</span> ç”¨æˆ·ä¿¡æ¯
                                </h4>
                                <div class="info-row">
                                    <span class="info-label">ç”¨æˆ·å:</span>
                                    <span class="info-value"><strong>${row.username || '-'}</strong></span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">ä¸»æœº:</span>
                                    <span class="info-value">${row.machine || '-'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">çŠ¶æ€:</span>
                                    <span class="info-value"><span class="badge badge-primary">${row.status || 'ACTIVE'}</span></span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">æ‰§è¡Œæ—¶é•¿:</span>
                                    <span class="info-value"><span class="badge ${durationClass}">${seconds} ç§’</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- SQLè¯­å¥ -->
                        <div style="margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #FF9800; padding-bottom: 5px;">
                                <span style="color: #FF9800;">ğŸ“</span> SQLè¯­å¥
                            </h4>
                            <pre style="background:#f5f5f5;padding:15px;border-radius:4px;overflow-x:auto;max-height:40vh;margin:0;border:1px solid #ddd;"><code>${sqlText}</code></pre>
                        </div>

                        <!-- æ“ä½œæç¤º -->
                        <div style="padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; margin-top: 15px;">
                            <small style="color: #856404;">
                                <strong>ğŸ’¡ æç¤º:</strong> æ‚¨å¯ä»¥å¤åˆ¶SQLè¯­å¥æˆ–ç»ˆæ­¢è¯¥ä¼šè¯
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="navigator.clipboard.writeText(\`${row.sql_text.replace(/`/g, '\\`')}\`).then(() => alert('SQLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))">
                            ğŸ“‹ å¤åˆ¶SQL
                        </button>
                        <button class="btn btn-danger" onclick="this.closest('.modal').remove();killRealtimeSession(${JSON.stringify(row).replace(/'/g, '&#39;')})">
                            âš ï¸ ç»ˆæ­¢ä¼šè¯
                        </button>
                        <button class="btn btn-primary" onclick="this.closest('.modal').remove()">å…³é—­</button>
                    </div>
                </div>
            `;

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);
        }

        // Deadlock Monitoring Functions
        async function loadDeadlocks() {
            const hours = document.getElementById('deadlockFilterHours').value;
            const instanceId = document.getElementById('deadlockFilterInstance').value;

            let url = `/api/deadlocks?hours=${hours}&page=${deadlockCurrentPage}`;
            if (instanceId) url += `&instance_id=${instanceId}`;

            const result = await api(url);
            const tbody = document.getElementById('deadlockTableBody');

            if (!result.success) {
                tbody.innerHTML = `<tr><td colspan="8" class="empty-state">åŠ è½½å¤±è´¥: ${result.error}</td></tr>`;
                return;
            }

            const data = result.data || [];
            const pagination = result.pagination || {};
            deadlockTotalPages = pagination.total_pages || 1;

            document.getElementById('deadlockPageInfo').textContent = `ç¬¬ ${pagination.current_page || 1} é¡µ / å…± ${deadlockTotalPages} é¡µ (${pagination.total_count || 0}æ¡)`;
            document.getElementById('deadlockPrevPage').disabled = !pagination.has_prev;
            document.getElementById('deadlockNextPage').disabled = !pagination.has_next;

            // æ›´æ–°å®ä¾‹è¿‡æ»¤å™¨ï¼ˆç§»åˆ°å‰é¢ï¼Œç¡®ä¿å³ä½¿æ²¡æœ‰æ•°æ®ä¹Ÿèƒ½åŠ è½½ï¼‰
            if (document.getElementById('deadlockFilterInstance').options.length === 1) {
                const instances = await api('/api/instances');
                if (instances.success) {
                    document.getElementById('deadlockFilterInstance').innerHTML = '<option value="">å…¨éƒ¨å®ä¾‹</option>' +
                        (instances.data || []).map(i => `<option value="${i.id}">${i.db_project} (${i.db_ip})</option>`).join('');
                }
            }

            if (!data.length) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">æš‚æ— æ­»é”è®°å½•</td></tr>';
                return;
            }

            // ä¿å­˜æ­»é”æ•°æ®åˆ°å…¨å±€å˜é‡
            window.deadlockData = window.deadlockData || {};

            tbody.innerHTML = data.map(row => {
                // ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œä½¿ç”¨IDä½œä¸ºé”®
                window.deadlockData[row.id] = row;

                return `<tr>
                    <td>${row.detect_time || '-'}</td>
                    <td>${row.db_project || '-'}<br><small style="color:#888">${row.db_ip || ''}:${row.db_port || ''}</small></td>
                    <td><span class="badge badge-primary">${row.db_type || 'MySQL'}</span></td>
                    <td>${row.victim_session_id || '-'}</td>
                    <td>${row.blocker_session_id || '-'}</td>
                    <td><code style="font-size:11px">${escapeHtml((row.wait_resource || '-').substring(0, 30))}</code></td>
                    <td><span class="badge badge-warning">${row.lock_mode || '-'}</span></td>
                    <td><button class="btn btn-sm btn-danger" onclick='showDeadlockDetail(${row.id})'>è¯¦æƒ…</button></td>
                </tr>`;
            }).join('');
        }

        function changeDeadlockPage(delta) {
            deadlockCurrentPage = Math.max(1, Math.min(deadlockTotalPages, deadlockCurrentPage + delta));
            loadDeadlocks();
        }

        function showDeadlockDetail(deadlockId) {
            // ä»å…¨å±€å˜é‡ä¸­è·å–æ­»é”æ•°æ®
            const deadlock = window.deadlockData && window.deadlockData[deadlockId];
            if (!deadlock) {
                alert('æ— æ³•æ‰¾åˆ°æ­»é”è¯¦æƒ…æ•°æ®');
                return;
            }

            const modal = document.getElementById('sqlModal');
            document.getElementById('modalDetectTime').textContent = deadlock.detect_time || '-';
            document.getElementById('modalDuration').textContent = 'æ­»é”äº‹ä»¶';
            document.getElementById('modalProject').textContent = deadlock.db_project || '-';
            document.getElementById('modalInstance').textContent = `${deadlock.db_ip}:${deadlock.db_port}`;
            document.getElementById('modalUser').textContent = `å—å®³è€…: ${deadlock.victim_session_id || '-'}`;
            document.getElementById('modalSession').textContent = `é˜»å¡è€…: ${deadlock.blocker_session_id || '-'}`;
            document.getElementById('modalProgram').textContent = `é”æ¨¡å¼: ${deadlock.lock_mode || '-'}`;
            document.getElementById('modalMachine').textContent = `ç­‰å¾…èµ„æº: ${deadlock.wait_resource || '-'}`;

            const sqlText = `-- å—å®³è€…SQL:\n${deadlock.victim_sql || 'N/A'}\n\n-- é˜»å¡è€…SQL:\n${deadlock.blocker_sql || 'N/A'}`;
            document.getElementById('modalSqlText').textContent = sqlText;

            // éšè—ä¸é€‚ç”¨çš„å­—æ®µ
            document.getElementById('modalStatus').style.display = 'none';
            document.getElementById('modalPerformance').style.display = 'none';
            document.getElementById('modalExplain').style.display = 'none';
            document.getElementById('modalKillBtn').style.display = 'none';

            modal.classList.add('show');
        }

        // Performance Metrics Functions
        async function loadPerformanceMetrics() {
            const container = document.getElementById('performanceMetricsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';

            const result = await api('/api/performance_metrics');

            if (!result.success) {
                container.innerHTML = `<div class="alert alert-danger">åŠ è½½å¤±è´¥: ${result.error}</div>`;
                return;
            }

            const data = result.data || [];

            if (!data.length) {
                container.innerHTML = '<div class="empty-state">æ²¡æœ‰å¯ç”¨çš„æ€§èƒ½æŒ‡æ ‡æ•°æ®</div>';
                return;
            }

            // ä¸ºæ¯ä¸ªå®ä¾‹åˆ›å»ºæ€§èƒ½æŒ‡æ ‡å¡ç‰‡
            container.innerHTML = data.map(metrics => `
                <div class="card" style="margin-bottom:20px;">
                    <div class="card-header">
                        <span class="card-title">${metrics.instance_name || metrics.db_project}</span>
                        <small style="color:#888;">${metrics.db_ip}:${metrics.db_port}</small>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid">
                            <div class="stat-card primary">
                                <div class="stat-label">QPS (æ¯ç§’æŸ¥è¯¢æ•°)</div>
                                <div class="stat-value">${metrics.qps || 0}</div>
                            </div>
                            <div class="stat-card success">
                                <div class="stat-label">TPS (æ¯ç§’äº‹åŠ¡æ•°)</div>
                                <div class="stat-value">${metrics.tps || 0}</div>
                            </div>
                            <div class="stat-card ${metrics.connection_warning ? 'danger' : 'warning'}">
                                <div class="stat-label">è¿æ¥ä½¿ç”¨ç‡</div>
                                <div class="stat-value">${metrics.connection_usage || 0}%</div>
                                <div class="stat-sublabel" style="font-size:12px;color:#888;margin-top:5px;">
                                    ${metrics.current_connections}/${metrics.max_connections} ${metrics.connection_warning ? 'âš  è¶…è¿‡80%' : 'âœ“ æ­£å¸¸'}
                                </div>
                            </div>
                            <div class="stat-card ${metrics.cache_warning ? 'danger' : 'success'}">
                                <div class="stat-label">ç¼“å­˜å‘½ä¸­ç‡</div>
                                <div class="stat-value">${metrics.cache_hit_rate || 0}%</div>
                                <div class="stat-sublabel" style="font-size:12px;color:#888;margin-top:5px;">
                                    ${metrics.cache_warning ? 'âš  ä½äº95%' : 'âœ“ æ­£å¸¸'}
                                </div>
                            </div>
                            <div class="stat-card secondary">
                                <div class="stat-label">æ…¢æŸ¥è¯¢ç´¯è®¡</div>
                                <div class="stat-value">${metrics.slow_queries || 0}</div>
                                <div class="stat-sublabel" style="font-size:12px;color:#888;margin-top:5px;">è‡ªå¯åŠ¨ä»¥æ¥</div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Prometheus Functions
        async function checkPrometheusHealth() {
            const statusDiv = document.getElementById('prometheusHealthStatus');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<div class="loading" style="padding:10px;"><div class="spinner" style="width:20px;height:20px;"></div><span style="margin-left:10px;">æ£€æŸ¥ä¸­...</span></div>';

            const result = await api('/api/prometheus/health');

            if (!result.success) {
                statusDiv.innerHTML = `<div class="alert alert-danger">æ£€æŸ¥å¤±è´¥: ${result.error}</div>`;
                return;
            }

            if (!result.enabled) {
                statusDiv.innerHTML = '<div class="alert alert-warning">âš ï¸ Prometheusæœªå¯ç”¨ï¼Œè¯·åœ¨config.jsonä¸­å¯ç”¨</div>';
            } else if (result.healthy) {
                statusDiv.innerHTML = `<div class="alert alert-success">âœ… Prometheusè¿æ¥æ­£å¸¸ (${result.url})</div>`;
                setTimeout(() => statusDiv.style.display = 'none', 3000);
            } else {
                statusDiv.innerHTML = `<div class="alert alert-danger">âŒ PrometheusæœåŠ¡ä¸å¯ç”¨ (${result.url})</div>`;
            }
        }

        async function loadPrometheusMetrics() {
            const select = document.getElementById('prometheusInstanceSelect');
            const instanceIp = select.value;

            if (!instanceIp) {
                return;
            }

            const container = document.getElementById('prometheusMetricsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';

            const result = await api(`/api/prometheus/metrics/${instanceIp}`);

            if (!result.success) {
                container.innerHTML = `<div class="alert alert-danger">åŠ è½½å¤±è´¥: ${result.error}</div>`;
                return;
            }

            const metrics = result.data;

            // æ ¼å¼åŒ–æ•°å€¼
            const formatValue = (val, decimals = 2) => {
                if (val === null || val === undefined) return '-';
                if (typeof val === 'number') return val.toFixed(decimals);
                return val;
            };

            // æ ¼å¼åŒ–ç™¾åˆ†æ¯”
            const formatPercent = (val, decimals = 2) => {
                if (val === null || val === undefined) return '-';
                return val.toFixed(decimals) + '%';
            };

            // æ¸²æŸ“æŒ‡æ ‡å¡ç‰‡
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color:#888; font-size:13px;">
                        ğŸ“Š å®ä¾‹: <strong>${select.options[select.selectedIndex].text}</strong> |
                        â±ï¸ é‡‡é›†æ—¶é—´: ${new Date(metrics.timestamp).toLocaleString('zh-CN')}
                    </p>
                </div>

                <!-- è¿æ¥å’Œæ€§èƒ½æŒ‡æ ‡ -->
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card primary">
                        <div class="stat-label">å½“å‰è¿æ¥æ•°</div>
                        <div class="stat-value">${formatValue(metrics.connections, 0)}</div>
                        <div class="stat-sublabel">${formatValue(metrics.max_connections, 0)} æœ€å¤§</div>
                    </div>
                    <div class="stat-card ${(metrics.connection_usage || 0) > 80 ? 'danger' : 'success'}">
                        <div class="stat-label">è¿æ¥ä½¿ç”¨ç‡</div>
                        <div class="stat-value">${formatPercent(metrics.connection_usage)}</div>
                        <div class="stat-sublabel">${(metrics.connection_usage || 0) > 80 ? 'âš ï¸ åé«˜' : 'âœ“ æ­£å¸¸'}</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">æ´»è·ƒçº¿ç¨‹</div>
                        <div class="stat-value">${formatValue(metrics.threads_running, 0)}</div>
                        <div class="stat-sublabel">æ­£åœ¨æ‰§è¡ŒæŸ¥è¯¢</div>
                    </div>
                    <div class="stat-card primary">
                        <div class="stat-label">QPS</div>
                        <div class="stat-value">${formatValue(metrics.qps, 2)}</div>
                        <div class="stat-sublabel">æ¯ç§’æŸ¥è¯¢æ•°</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">TPS</div>
                        <div class="stat-value">${formatValue(metrics.tps, 2)}</div>
                        <div class="stat-sublabel">æ¯ç§’äº‹åŠ¡æ•°</div>
                    </div>
                </div>

                <!-- Buffer PoolæŒ‡æ ‡ -->
                <h4 style="margin: 20px 0 10px 0; color: #333;">ğŸ—„ï¸ InnoDB Buffer Pool</h4>
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card ${(metrics.buffer_pool_hit_rate || 0) < 95 ? 'warning' : 'success'}">
                        <div class="stat-label">ç¼“å­˜å‘½ä¸­ç‡</div>
                        <div class="stat-value">${formatPercent(metrics.buffer_pool_hit_rate)}</div>
                        <div class="stat-sublabel">${(metrics.buffer_pool_hit_rate || 0) < 95 ? 'âš ï¸ åä½' : 'âœ“ æ­£å¸¸'}</div>
                    </div>
                    <div class="stat-card primary">
                        <div class="stat-label">ç¼“å­˜ä½¿ç”¨ç‡</div>
                        <div class="stat-value">${formatPercent(metrics.buffer_pool_usage)}</div>
                        <div class="stat-sublabel">æ•°æ®å ç”¨</div>
                    </div>
                    <div class="stat-card ${(metrics.buffer_pool_dirty_pages || 0) > 10 ? 'warning' : 'success'}">
                        <div class="stat-label">è„é¡µæ¯”ä¾‹</div>
                        <div class="stat-value">${formatPercent(metrics.buffer_pool_dirty_pages)}</div>
                        <div class="stat-sublabel">${(metrics.buffer_pool_dirty_pages || 0) > 10 ? 'âš ï¸ åé«˜' : 'âœ“ æ­£å¸¸'}</div>
                    </div>
                </div>

                <!-- å¤åˆ¶çŠ¶æ€ -->
                ${metrics.replication_lag !== null ? `
                <h4 style="margin: 20px 0 10px 0; color: #333;">ğŸ”„ ä¸»ä»å¤åˆ¶</h4>
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card ${(metrics.replication_lag || 0) > 60 ? 'danger' : (metrics.replication_lag || 0) > 10 ? 'warning' : 'success'}">
                        <div class="stat-label">å¤åˆ¶å»¶è¿Ÿ</div>
                        <div class="stat-value">${formatValue(metrics.replication_lag, 0)}<small>ç§’</small></div>
                        <div class="stat-sublabel">${(metrics.replication_lag || 0) > 60 ? 'âŒ ä¸¥é‡å»¶è¿Ÿ' : (metrics.replication_lag || 0) > 10 ? 'âš ï¸ æœ‰å»¶è¿Ÿ' : 'âœ“ æ­£å¸¸'}</div>
                    </div>
                    <div class="stat-card ${metrics.slave_io_running === 1 ? 'success' : 'danger'}">
                        <div class="stat-label">IOçº¿ç¨‹</div>
                        <div class="stat-value">${metrics.slave_io_running === 1 ? 'Running' : 'Stopped'}</div>
                        <div class="stat-sublabel">${metrics.slave_io_running === 1 ? 'âœ“ æ­£å¸¸' : 'âŒ å¼‚å¸¸'}</div>
                    </div>
                    <div class="stat-card ${metrics.slave_sql_running === 1 ? 'success' : 'danger'}">
                        <div class="stat-label">SQLçº¿ç¨‹</div>
                        <div class="stat-value">${metrics.slave_sql_running === 1 ? 'Running' : 'Stopped'}</div>
                        <div class="stat-sublabel">${metrics.slave_sql_running === 1 ? 'âœ“ æ­£å¸¸' : 'âŒ å¼‚å¸¸'}</div>
                    </div>
                </div>
                ` : ''}

                <!-- æ…¢æŸ¥è¯¢å’Œé” -->
                <h4 style="margin: 20px 0 10px 0; color: #333;">âš ï¸ æ…¢æŸ¥è¯¢ä¸é”</h4>
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card ${(metrics.slow_queries_rate || 0) > 1 ? 'warning' : 'success'}">
                        <div class="stat-label">æ…¢æŸ¥è¯¢é€Ÿç‡</div>
                        <div class="stat-value">${formatValue(metrics.slow_queries_rate, 3)}<small>/ç§’</small></div>
                        <div class="stat-sublabel">${(metrics.slow_queries_rate || 0) > 1 ? 'âš ï¸ åé«˜' : 'âœ“ æ­£å¸¸'}</div>
                    </div>
                    <div class="stat-card ${(metrics.innodb_row_lock_waits || 0) > 100 ? 'danger' : 'success'}">
                        <div class="stat-label">è¡Œé”ç­‰å¾…</div>
                        <div class="stat-value">${formatValue(metrics.innodb_row_lock_waits, 0)}</div>
                        <div class="stat-sublabel">${(metrics.innodb_row_lock_waits || 0) > 100 ? 'âš ï¸ åå¤š' : 'âœ“ æ­£å¸¸'}</div>
                    </div>
                    <div class="stat-card primary">
                        <div class="stat-label">å¹³å‡è¡Œé”æ—¶é—´</div>
                        <div class="stat-value">${formatValue(metrics.innodb_row_lock_time_avg, 2)}<small>ms</small></div>
                        <div class="stat-sublabel">å¹³å‡ç­‰å¾…</div>
                    </div>
                    <div class="stat-card ${(metrics.table_locks_waited || 0) > 10 ? 'warning' : 'success'}">
                        <div class="stat-label">è¡¨é”ç­‰å¾…</div>
                        <div class="stat-value">${formatValue(metrics.table_locks_waited, 0)}</div>
                        <div class="stat-sublabel">${(metrics.table_locks_waited || 0) > 10 ? 'âš ï¸ åå¤š' : 'âœ“ æ­£å¸¸'}</div>
                    </div>
                </div>

                <!-- ä¸´æ—¶è¡¨ -->
                <h4 style="margin: 20px 0 10px 0; color: #333;">ğŸ“‹ ä¸´æ—¶è¡¨</h4>
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card primary">
                        <div class="stat-label">ä¸´æ—¶è¡¨åˆ›å»ºé€Ÿç‡</div>
                        <div class="stat-value">${formatValue(metrics.tmp_tables_rate, 2)}<small>/ç§’</small></div>
                        <div class="stat-sublabel">å†…å­˜ä¸´æ—¶è¡¨</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">ç£ç›˜ä¸´æ—¶è¡¨é€Ÿç‡</div>
                        <div class="stat-value">${formatValue(metrics.tmp_disk_tables_rate, 2)}<small>/ç§’</small></div>
                        <div class="stat-sublabel">ç£ç›˜ä¸´æ—¶è¡¨</div>
                    </div>
                    <div class="stat-card ${(metrics.tmp_disk_tables_ratio || 0) > 25 ? 'danger' : 'success'}">
                        <div class="stat-label">ç£ç›˜ä¸´æ—¶è¡¨æ¯”ä¾‹</div>
                        <div class="stat-value">${formatPercent(metrics.tmp_disk_tables_ratio)}</div>
                        <div class="stat-sublabel">${(metrics.tmp_disk_tables_ratio || 0) > 25 ? 'âš ï¸ åé«˜' : 'âœ“ æ­£å¸¸'}</div>
                    </div>
                </div>

                <!-- ç£ç›˜IO -->
                <h4 style="margin: 20px 0 10px 0; color: #333;">ğŸ’¾ ç£ç›˜IO</h4>
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card primary">
                        <div class="stat-label">æ•°æ®è¯»å–é€Ÿç‡</div>
                        <div class="stat-value">${formatValue(metrics.innodb_data_reads_rate, 2)}<small>/ç§’</small></div>
                        <div class="stat-sublabel">InnoDBè¯»æ“ä½œ</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">æ•°æ®å†™å…¥é€Ÿç‡</div>
                        <div class="stat-value">${formatValue(metrics.innodb_data_writes_rate, 2)}<small>/ç§’</small></div>
                        <div class="stat-sublabel">InnoDBå†™æ“ä½œ</div>
                    </div>
                </div>

                <!-- ç³»ç»Ÿèµ„æº (å¦‚æœæœ‰) -->
                ${metrics.cpu_usage !== null || metrics.memory_usage_mb !== null ? `
                <h4 style="margin: 20px 0 10px 0; color: #333;">ğŸ–¥ï¸ ç³»ç»Ÿèµ„æº</h4>
                <div class="stats-grid" style="margin-bottom: 30px;">
                    ${metrics.cpu_usage !== null ? `
                    <div class="stat-card ${(metrics.cpu_usage || 0) > 80 ? 'danger' : (metrics.cpu_usage || 0) > 50 ? 'warning' : 'success'}">
                        <div class="stat-label">CPUä½¿ç”¨ç‡</div>
                        <div class="stat-value">${formatPercent(metrics.cpu_usage)}</div>
                        <div class="stat-sublabel">${(metrics.cpu_usage || 0) > 80 ? 'âš ï¸ åé«˜' : 'âœ“ æ­£å¸¸'}</div>
                    </div>
                    ` : ''}
                    ${metrics.memory_usage_mb !== null ? `
                    <div class="stat-card primary">
                        <div class="stat-label">å†…å­˜ä½¿ç”¨</div>
                        <div class="stat-value">${formatValue(metrics.memory_usage_mb, 0)}<small>MB</small></div>
                        <div class="stat-sublabel">è¿›ç¨‹å†…å­˜</div>
                    </div>
                    ` : ''}
                </div>
                ` : ''}

                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #2196F3;">
                    <p style="margin: 0; color: #666; font-size: 13px;">
                        ğŸ’¡ <strong>è¯´æ˜</strong>: æ•°æ®æ¥æºäºPrometheus MySQL Exporterï¼Œé‡‡é›†é—´éš”ç”±Prometheusé…ç½®å†³å®šï¼ˆé»˜è®¤15ç§’ï¼‰
                    </p>
                </div>
            `;
        }

        async function loadPrometheusInstances() {
            const result = await api('/api/config');

            if (!result.success) {
                console.error('Failed to load Prometheus instances:', result.error);
                return;
            }

            const config = result.data;
            const exporterMapping = config.exporter_mapping || {};
            const select = document.getElementById('prometheusInstanceSelect');

            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ªé»˜è®¤é€‰é¡¹ï¼‰
            while (select.options.length > 1) {
                select.remove(1);
            }

            // æ·»åŠ å®ä¾‹é€‰é¡¹
            Object.keys(exporterMapping).forEach(instanceIp => {
                const option = document.createElement('option');
                option.value = instanceIp;
                option.textContent = `${instanceIp} (${exporterMapping[instanceIp]})`;
                select.appendChild(option);
            });
        }

        async function loadPrometheusSqlServerInstances() {
            const result = await api('/api/config');

            if (!result.success) {
                console.error('Failed to load SQL Server instances:', result.error);
                return;
            }

            const config = result.data;
            const sqlserverMapping = config.sqlserver_exporter_mapping || {};
            const select = document.getElementById('prometheusSqlServerSelect');

            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ªé»˜è®¤é€‰é¡¹ï¼‰
            while (select.options.length > 1) {
                select.remove(1);
            }

            // æ·»åŠ SQL Serverå®ä¾‹é€‰é¡¹
            Object.keys(sqlserverMapping).forEach(instanceIp => {
                if (instanceIp !== '_comment') {  // è·³è¿‡æ³¨é‡Šå­—æ®µ
                    const option = document.createElement('option');
                    option.value = instanceIp;
                    option.textContent = `${instanceIp} (${sqlserverMapping[instanceIp]})`;
                    select.appendChild(option);
                }
            });

            // å¦‚æœæ²¡æœ‰SQL Serverå®ä¾‹ï¼Œæ˜¾ç¤ºæç¤º
            if (Object.keys(sqlserverMapping).filter(k => k !== '_comment').length === 0) {
                select.innerHTML = '<option value="">æš‚æ— SQL Serverå®ä¾‹é…ç½®</option>';
            }
        }

        async function loadPrometheusSqlServerMetrics() {
            const select = document.getElementById('prometheusSqlServerSelect');
            const instanceIp = select.value;

            if (!instanceIp || instanceIp === 'æš‚æ— SQL Serverå®ä¾‹é…ç½®') {
                return;
            }

            const container = document.getElementById('prometheusSqlServerContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';

            const result = await api(`/api/prometheus/sqlserver/metrics/${instanceIp}`);

            if (!result.success) {
                container.innerHTML = `<div class="alert alert-danger">åŠ è½½å¤±è´¥: ${result.error}</div>`;
                return;
            }

            const metrics = result.data;

            // æ ¼å¼åŒ–æ•°å€¼
            const formatValue = (val, decimals = 2) => {
                if (val === null || val === undefined) return '-';
                if (typeof val === 'number') return val.toFixed(decimals);
                return val;
            };

            // æ ¼å¼åŒ–ç™¾åˆ†æ¯”
            const formatPercent = (val, decimals = 2) => {
                if (val === null || val === undefined) return '-';
                return val.toFixed(decimals) + '%';
            };

            // æ¸²æŸ“SQL ServeræŒ‡æ ‡å¡ç‰‡
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color:#888; font-size:13px;">
                        ğŸ—„ï¸ æ•°æ®åº“ç±»å‹: <strong>SQL Server</strong> |
                        ğŸ“Š å®ä¾‹: <strong>${select.options[select.selectedIndex].text}</strong> |
                        â±ï¸ é‡‡é›†æ—¶é—´: ${new Date(metrics.timestamp).toLocaleString('zh-CN')}
                    </p>
                </div>

                <!-- è¿æ¥å’Œæ€§èƒ½æŒ‡æ ‡ -->
                <h4 style="margin: 20px 0 10px 0; color: #333;">ğŸ”Œ è¿æ¥å’Œæ€§èƒ½</h4>
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card primary">
                        <div class="stat-label">å½“å‰è¿æ¥æ•°</div>
                        <div class="stat-value">${formatValue(metrics.connections, 0)}</div>
                        <div class="stat-sublabel">${formatValue(metrics.max_connections, 0)} æœ€å¤§</div>
                    </div>
                    <div class="stat-card ${(metrics.connection_usage || 0) > 80 ? 'danger' : 'success'}">
                        <div class="stat-label">è¿æ¥ä½¿ç”¨ç‡</div>
                        <div class="stat-value">${formatPercent(metrics.connection_usage)}</div>
                        <div class="stat-sublabel">${(metrics.connection_usage || 0) > 80 ? 'âš ï¸ åé«˜' : 'âœ“ æ­£å¸¸'}</div>
                    </div>
                    <div class="stat-card primary">
                        <div class="stat-label">æ‰¹å¤„ç†è¯·æ±‚/ç§’</div>
                        <div class="stat-value">${formatValue(metrics.batch_requests, 2)}</div>
                        <div class="stat-sublabel">ç±»ä¼¼QPS</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">SQLç¼–è¯‘æ•°/ç§’</div>
                        <div class="stat-value">${formatValue(metrics.sql_compilations, 2)}</div>
                        <div class="stat-sublabel">ç¼–è¯‘å¼€é”€</div>
                    </div>
                </div>

                <!-- ç¼“å­˜å’Œå†…å­˜æŒ‡æ ‡ -->
                <h4 style="margin: 20px 0 10px 0; color: #333;">ğŸ’¾ Buffer Cache</h4>
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card ${(metrics.buffer_cache_hit_ratio || 0) < 95 ? 'warning' : 'success'}">
                        <div class="stat-label">Buffer Cacheå‘½ä¸­ç‡</div>
                        <div class="stat-value">${formatPercent(metrics.buffer_cache_hit_ratio)}</div>
                        <div class="stat-sublabel">${(metrics.buffer_cache_hit_ratio || 0) < 95 ? 'âš ï¸ åä½' : 'âœ“ æ­£å¸¸'}</div>
                    </div>
                    <div class="stat-card ${(metrics.page_life_expectancy || 0) < 300 ? 'danger' : 'success'}">
                        <div class="stat-label">é¡µé¢ç”Ÿå‘½æœŸæœ›å€¼</div>
                        <div class="stat-value">${formatValue(metrics.page_life_expectancy, 0)}<small>ç§’</small></div>
                        <div class="stat-sublabel">${(metrics.page_life_expectancy || 0) < 300 ? 'âš ï¸ å†…å­˜å‹åŠ›å¤§' : 'âœ“ æ­£å¸¸'}</div>
                    </div>
                    <div class="stat-card primary">
                        <div class="stat-label">ç›®æ ‡å†…å­˜</div>
                        <div class="stat-value">${formatValue(metrics.target_memory_mb, 0)}<small>MB</small></div>
                        <div class="stat-sublabel">Target Memory</div>
                    </div>
                    <div class="stat-card ${(metrics.memory_pressure || 0) > 95 ? 'warning' : 'success'}">
                        <div class="stat-label">å†…å­˜å‹åŠ›</div>
                        <div class="stat-value">${formatPercent(metrics.memory_pressure)}</div>
                        <div class="stat-sublabel">${formatValue(metrics.total_memory_mb, 0)} MB</div>
                    </div>
                </div>

                <!-- é”å’Œæ­»é” -->
                <h4 style="margin: 20px 0 10px 0; color: #333;">ğŸ”’ é”å’Œæ­»é”</h4>
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card ${(metrics.lock_waits_rate || 0) > 10 ? 'danger' : 'success'}">
                        <div class="stat-label">é”ç­‰å¾…/ç§’</div>
                        <div class="stat-value">${formatValue(metrics.lock_waits_rate, 2)}</div>
                        <div class="stat-sublabel">${(metrics.lock_waits_rate || 0) > 10 ? 'âš ï¸ åé«˜' : 'âœ“ æ­£å¸¸'}</div>
                    </div>
                    <div class="stat-card ${(metrics.deadlocks_rate || 0) > 0 ? 'danger' : 'success'}">
                        <div class="stat-label">æ­»é”æ•°/ç§’</div>
                        <div class="stat-value">${formatValue(metrics.deadlocks_rate, 3)}</div>
                        <div class="stat-sublabel">${(metrics.deadlocks_rate || 0) > 0 ? 'âš ï¸ æœ‰æ­»é”' : 'âœ“ æ­£å¸¸'}</div>
                    </div>
                    <div class="stat-card ${(metrics.io_stall_seconds || 0) > 0.1 ? 'warning' : 'success'}">
                        <div class="stat-label">IOå»¶è¿Ÿ</div>
                        <div class="stat-value">${formatValue(metrics.io_stall_seconds, 3)}<small>ç§’</small></div>
                        <div class="stat-sublabel">${(metrics.io_stall_seconds || 0) > 0.1 ? 'âš ï¸ åé«˜' : 'âœ“ æ­£å¸¸'}</div>
                    </div>
                    <div class="stat-card ${(metrics.user_errors_rate || 0) > 1 ? 'warning' : 'success'}">
                        <div class="stat-label">ç”¨æˆ·é”™è¯¯/ç§’</div>
                        <div class="stat-value">${formatValue(metrics.user_errors_rate, 2)}</div>
                        <div class="stat-sublabel">${(metrics.user_errors_rate || 0) > 1 ? 'âš ï¸ åå¤š' : 'âœ“ æ­£å¸¸'}</div>
                    </div>
                </div>

                <!-- Always Onå¯ç”¨æ€§ç»„ -->
                ${metrics.ao_sync_health !== null || metrics.database_state !== null ? `
                <h4 style="margin: 20px 0 10px 0; color: #333;">ğŸ”„ Always Onå¯ç”¨æ€§ç»„</h4>
                <div class="stats-grid" style="margin-bottom: 30px;">
                    ${metrics.ao_sync_health !== null ? `
                    <div class="stat-card ${metrics.ao_sync_health === 1 ? 'success' : 'danger'}">
                        <div class="stat-label">åŒæ­¥å¥åº·çŠ¶æ€</div>
                        <div class="stat-value">${metrics.ao_sync_health === 1 ? 'Healthy' : 'Unhealthy'}</div>
                        <div class="stat-sublabel">${metrics.ao_sync_health === 1 ? 'âœ“ æ­£å¸¸' : 'âŒ å¼‚å¸¸'}</div>
                    </div>
                    ` : ''}
                    ${metrics.database_state !== null ? `
                    <div class="stat-card ${metrics.database_state === 0 ? 'success' : 'warning'}">
                        <div class="stat-label">æ•°æ®åº“çŠ¶æ€</div>
                        <div class="stat-value">${metrics.database_state === 0 ? 'Online' : 'Other'}</div>
                        <div class="stat-sublabel">${metrics.database_state === 0 ? 'âœ“ åœ¨çº¿' : 'âš ï¸ æ£€æŸ¥'}</div>
                    </div>
                    ` : ''}
                </div>
                ` : ''}

                <!-- ç³»ç»Ÿèµ„æº -->
                ${metrics.cpu_usage !== null || metrics.memory_usage_mb !== null ? `
                <h4 style="margin: 20px 0 10px 0; color: #333;">ğŸ–¥ï¸ ç³»ç»Ÿèµ„æº</h4>
                <div class="stats-grid" style="margin-bottom: 30px;">
                    ${metrics.cpu_usage !== null ? `
                    <div class="stat-card ${(metrics.cpu_usage || 0) > 80 ? 'danger' : (metrics.cpu_usage || 0) > 50 ? 'warning' : 'success'}">
                        <div class="stat-label">CPUä½¿ç”¨ç‡</div>
                        <div class="stat-value">${formatPercent(metrics.cpu_usage)}</div>
                        <div class="stat-sublabel">${(metrics.cpu_usage || 0) > 80 ? 'âš ï¸ åé«˜' : 'âœ“ æ­£å¸¸'}</div>
                    </div>
                    ` : ''}
                    ${metrics.memory_usage_mb !== null ? `
                    <div class="stat-card primary">
                        <div class="stat-label">è¿›ç¨‹å†…å­˜</div>
                        <div class="stat-value">${formatValue(metrics.memory_usage_mb, 0)}<small>MB</small></div>
                        <div class="stat-sublabel">å·²ä½¿ç”¨</div>
                    </div>
                    ` : ''}
                </div>
                ` : ''}

                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                    <p style="margin: 0; color: #666; font-size: 13px;">
                        ğŸ’¡ <strong>è¯´æ˜</strong>: æ•°æ®æ¥æºäºPrometheus SQL Server Exporterã€‚
                        ${Object.keys(metrics).filter(k => metrics[k] === null).length > 0 ?
                        `éƒ¨åˆ†æŒ‡æ ‡è¿”å›nullå¯èƒ½æ˜¯å› ä¸ºExporterä¸­æœªé…ç½®å¯¹åº”çš„metricã€‚` : ''}
                    </p>
                </div>
            `;
        }

        async function loadBlockingQueries() {
            const container = document.getElementById('blockingQueriesContainer');
            const minWaitSeconds = document.getElementById('blockingWaitSeconds').value || 10;

            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>æ£€æµ‹ä¸­...</p></div>';

            const result = await api(`/api/blocking_queries?min_wait_seconds=${minWaitSeconds}`);

            if (!result.success) {
                container.innerHTML = `<div class="alert alert-danger">æ£€æµ‹å¤±è´¥: ${result.error}</div>`;
                return;
            }

            const data = result.data || [];

            if (!data.length) {
                container.innerHTML = '<div class="empty-state">æœªæ£€æµ‹åˆ°é˜»å¡æŸ¥è¯¢</div>';
                return;
            }

            // æ˜¾ç¤ºé˜»å¡æŸ¥è¯¢è¡¨æ ¼
            container.innerHTML = `
                <div class="alert alert-warning">æ£€æµ‹åˆ° ${data.length} ä¸ªé˜»å¡ä¼šè¯</div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>å®ä¾‹</th>
                                <th>è¢«é˜»å¡ä¼šè¯</th>
                                <th>è¢«é˜»å¡SQL</th>
                                <th>é˜»å¡ä¼šè¯</th>
                                <th>é˜»å¡SQL</th>
                                <th>ç­‰å¾…æ—¶é•¿</th>
                                <th>å»ºè®®æ“ä½œ</th>
                                <th>æ£€æµ‹æ–¹å¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(row => `<tr>
                                <td>${row.db_project}<br><small style="color:#888">${row.db_ip}:${row.db_port}</small></td>
                                <td><code>${row.blocked_thread}</code></td>
                                <td><div class="sql-text" style="max-width:200px">${escapeHtml((row.blocked_sql || 'N/A').substring(0, 100))}</div></td>
                                <td><code>${row.blocking_thread}</code></td>
                                <td><div class="sql-text" style="max-width:200px">${escapeHtml((row.blocking_sql || 'N/A').substring(0, 100))}</div></td>
                                <td><span class="badge badge-danger">${row.wait_time}</span></td>
                                <td><code style="font-size:11px">${row.kill_command}</code></td>
                                <td><small>${row.detection_method}</small></td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function loadReplicationStatus() {
            const container = document.getElementById('replicationStatusContainer');

            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>æ£€æµ‹ä¸­...</p></div>';

            const result = await api('/api/replication_status');

            if (!result.success) {
                container.innerHTML = `<div class="alert alert-danger">æ£€æµ‹å¤±è´¥: ${result.error}</div>`;
                return;
            }

            const data = result.data || [];

            if (!data.length) {
                container.innerHTML = '<div class="empty-state">æœªé…ç½®ä¸»ä»å¤åˆ¶æˆ–æ— å¤åˆ¶å®ä¾‹</div>';
                return;
            }

            // æ˜¾ç¤ºå¤åˆ¶çŠ¶æ€è¡¨æ ¼
            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ä»åº“å®ä¾‹</th>
                                <th>ä¸»åº“åœ°å€</th>
                                <th>IOçº¿ç¨‹</th>
                                <th>SQLçº¿ç¨‹</th>
                                <th>å»¶è¿Ÿ(ç§’)</th>
                                <th>çŠ¶æ€</th>
                                <th>é”™è¯¯ä¿¡æ¯</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(row => `<tr>
                                <td>${row.db_project}<br><small style="color:#888">${row.db_ip}:${row.db_port}</small></td>
                                <td>${row.master_host}:${row.master_port}</td>
                                <td><span class="badge ${row.slave_io_running === 'Yes' ? 'badge-success' : 'badge-danger'}">${row.slave_io_running}</span></td>
                                <td><span class="badge ${row.slave_sql_running === 'Yes' ? 'badge-success' : 'badge-danger'}">${row.slave_sql_running}</span></td>
                                <td>
                                    <span class="badge ${row.lag_warning ? 'badge-danger' : 'badge-success'}">
                                        ${row.seconds_behind_master !== null ? row.seconds_behind_master : 'NULL'}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge ${row.replication_healthy ? 'badge-success' : 'badge-danger'}">
                                        ${row.replication_healthy ? 'æ­£å¸¸' : 'å¼‚å¸¸'}
                                    </span>
                                </td>
                                <td><small style="color:#dc3545">${row.last_io_error || row.last_sql_error || '-'}</small></td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function loadAlwaysOnStatus() {
            const container = document.getElementById('alwaysOnStatusContainer');

            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>æ£€æµ‹ä¸­...</p></div>';

            const result = await api('/api/alwayson_status');

            if (!result.success) {
                container.innerHTML = `<div class="alert alert-danger">æ£€æµ‹å¤±è´¥: ${result.error}</div>`;
                return;
            }

            const data = result.data || [];

            if (!data.length) {
                container.innerHTML = '<div class="empty-state">æœªé…ç½®Always Onæˆ–æ— å¯ç”¨æ€§ç»„</div>';
                return;
            }

            // æŒ‰å¯ç”¨æ€§ç»„å’Œå®ä¾‹åˆ†ç»„æ˜¾ç¤º
            const groups = {};
            data.forEach(row => {
                const key = `${row.instance_id}_${row.ag_name}`;
                if (!groups[key]) {
                    groups[key] = {
                        instance: row.db_project,
                        ip: row.db_ip,
                        port: row.db_port,
                        ag_name: row.ag_name,
                        role: row.role,
                        databases: []
                    };
                }
                groups[key].databases.push(row);
            });

            // æ˜¾ç¤ºAlways OnçŠ¶æ€
            container.innerHTML = Object.values(groups).map(group => `
                <div style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 4px; padding: 15px; background: #f9f9f9;">
                    <h4 style="margin: 0 0 15px 0; color: #333;">
                        ${group.instance} - ${group.ag_name}
                        <span class="badge ${group.role === 'PRIMARY' ? 'badge-primary' : 'badge-secondary'}">${group.role}</span>
                    </h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>æ•°æ®åº“</th>
                                    <th>å‰¯æœ¬æœåŠ¡å™¨</th>
                                    <th>åŒæ­¥æ¨¡å¼</th>
                                    <th>æ•…éšœè½¬ç§»æ¨¡å¼</th>
                                    <th>åŒæ­¥çŠ¶æ€</th>
                                    <th>è¿æ¥çŠ¶æ€</th>
                                    <th>å»¶è¿Ÿ(ç§’)</th>
                                    <th>æ—¥å¿—å‘é€é˜Ÿåˆ—(KB)</th>
                                    <th>é‡åšé˜Ÿåˆ—(KB)</th>
                                    <th>å¥åº·çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${group.databases.map(db => `<tr>
                                    <td><strong>${db.database_name || '-'}</strong></td>
                                    <td>${db.replica_server}</td>
                                    <td><span class="badge ${db.availability_mode === 'SYNCHRONOUS_COMMIT' ? 'badge-success' : 'badge-warning'}">${db.availability_mode}</span></td>
                                    <td><span class="badge badge-secondary">${db.failover_mode}</span></td>
                                    <td><span class="badge ${db.sync_state === 'SYNCHRONIZED' ? 'badge-success' : 'badge-warning'}">${db.sync_state || '-'}</span></td>
                                    <td><span class="badge ${db.connected_state === 'CONNECTED' ? 'badge-success' : 'badge-danger'}">${db.connected_state}</span></td>
                                    <td>
                                        <span class="badge ${db.lag_warning ? 'badge-danger' : 'badge-success'}">
                                            ${db.lag_seconds !== null ? db.lag_seconds : 'N/A'}
                                        </span>
                                    </td>
                                    <td>${db.log_send_queue_kb.toFixed(2)}</td>
                                    <td>${db.redo_queue_kb.toFixed(2)}</td>
                                    <td>
                                        ${db.is_suspended ? '<span class="badge badge-danger">å·²æš‚åœ</span>' : ''}
                                        <span class="badge ${db.is_healthy ? 'badge-success' : 'badge-danger'}">
                                            ${db.is_healthy ? 'å¥åº·' : 'å¼‚å¸¸'}
                                        </span>
                                        ${db.suspend_reason ? `<br><small style="color:#dc3545">${db.suspend_reason}</small>` : ''}
                                    </td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');
        }

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) this.classList.remove('show');
            });
        });
    </script>
</body>
</html>
