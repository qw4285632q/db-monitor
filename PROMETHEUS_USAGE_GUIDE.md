# Prometheusç›‘æŽ§ä½¿ç”¨æŒ‡å—

## å¿«é€Ÿå¼€å§‹

### 1. è®¿é—®ç›‘æŽ§ç³»ç»Ÿ

æ‰“å¼€æµè§ˆå™¨è®¿é—®:
- æœ¬åœ°è®¿é—®: http://localhost:5000
- ç½‘ç»œè®¿é—®: http://10.100.1.135:5000

### 2. æŸ¥çœ‹Prometheusç›‘æŽ§

1. ç‚¹å‡»é¡¶éƒ¨å¯¼èˆªæ çš„ **"æ€§èƒ½æŒ‡æ ‡"** æ ‡ç­¾
2. æ‰¾åˆ° **"ç³»ç»Ÿèµ„æºç›‘æŽ§ (Prometheus)"** å¡ç‰‡
3. åœ¨ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©è¦ç›‘æŽ§çš„MySQLå®žä¾‹
4. ç‚¹å‡» **"åˆ·æ–°"** æŒ‰é’®æŸ¥çœ‹æœ€æ–°æŒ‡æ ‡
5. ç‚¹å‡» **"æ£€æŸ¥è¿žæŽ¥"** æŒ‰é’®æµ‹è¯•Prometheusè¿žæŽ¥çŠ¶æ€

## å¯ç”¨çš„MySQLå®žä¾‹

é…ç½®æ–‡ä»¶ä¸­å·²æ·»åŠ 6ä¸ªMySQLå®žä¾‹ï¼š

| IPåœ°å€ | Exporterç«¯å£ | çŠ¶æ€ |
|--------|-------------|------|
| 192.168.44.71 | 19987 | âœ… UP |
| 192.168.46.101 | 19993 | âœ… UP |
| 192.168.46.102 | 19998 | âœ… UP |
| 192.168.44.141 | 19994 | âœ… UP |
| 10.111.1.152 | 20010 | âœ… UP |
| 10.111.3.22 | 20011 | âœ… UP |

## å½“å‰å¯ç”¨æŒ‡æ ‡

### âœ… è¿žæŽ¥æŒ‡æ ‡ (4é¡¹)
- **å½“å‰è¿žæŽ¥æ•°**: å®žæ—¶è¿žæŽ¥æ•°é‡
- **æœ€å¤§è¿žæŽ¥æ•°**: é…ç½®çš„æœ€å¤§è¿žæŽ¥æ•°
- **è¿žæŽ¥ä½¿ç”¨çŽ‡**: ç™¾åˆ†æ¯” (>80%çº¢è‰²å‘Šè­¦)
- **æ´»è·ƒçº¿ç¨‹**: æ­£åœ¨æ‰§è¡ŒæŸ¥è¯¢çš„çº¿ç¨‹æ•°

### âœ… Buffer PoolæŒ‡æ ‡ (3é¡¹)
- **ç¼“å­˜å‘½ä¸­çŽ‡**: ç™¾åˆ†æ¯” (<95%é»„è‰²å‘Šè­¦)
- **ç¼“å­˜ä½¿ç”¨çŽ‡**: æ•°æ®å ç”¨ç™¾åˆ†æ¯”
- **è„é¡µæ¯”ä¾‹**: å¾…åˆ·æ–°åˆ°ç£ç›˜çš„è„é¡µæ¯”ä¾‹ (>10%é»„è‰²å‘Šè­¦)

### âœ… ä¸»ä»Žå¤åˆ¶æŒ‡æ ‡ (3é¡¹)
- **å¤åˆ¶å»¶è¿Ÿ**: ç§’æ•° (>10ç§’é»„è‰²ï¼Œ>60ç§’çº¢è‰²)
- **IOçº¿ç¨‹çŠ¶æ€**: Running/Stopped
- **SQLçº¿ç¨‹çŠ¶æ€**: Running/Stopped

### âœ… é”æŒ‡æ ‡ (3é¡¹)
- **è¡Œé”ç­‰å¾…**: æ¬¡æ•° (>100æ¬¡çº¢è‰²å‘Šè­¦)
- **å¹³å‡è¡Œé”æ—¶é—´**: æ¯«ç§’
- **è¡¨é”ç­‰å¾…**: æ¬¡æ•° (>10æ¬¡é»„è‰²å‘Šè­¦)

### âœ… æ…¢æŸ¥è¯¢æŒ‡æ ‡ (1é¡¹)
- **æ…¢æŸ¥è¯¢é€ŸçŽ‡**: æ¯ç§’æ…¢æŸ¥è¯¢æ•° (>1/ç§’é»„è‰²å‘Šè­¦)

### âœ… ç³»ç»Ÿèµ„æºæŒ‡æ ‡ (2é¡¹)
- **CPUä½¿ç”¨çŽ‡**: ç™¾åˆ†æ¯” (>50%é»„è‰²ï¼Œ>80%çº¢è‰²)
- **å†…å­˜ä½¿ç”¨**: MB

### âš ï¸ éƒ¨åˆ†å¯ç”¨æŒ‡æ ‡

ä»¥ä¸‹æŒ‡æ ‡åœ¨æŸäº›å®žä¾‹ä¸Šå¯èƒ½è¿”å›žnullï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒæ•´PromQLæŸ¥è¯¢ï¼š

- **QPS** (æ¯ç§’æŸ¥è¯¢æ•°)
- **TPS** (æ¯ç§’äº‹åŠ¡æ•°)
- **ä¸´æ—¶è¡¨åˆ›å»ºé€ŸçŽ‡**
- **ç£ç›˜ä¸´æ—¶è¡¨é€ŸçŽ‡**
- **ç£ç›˜ä¸´æ—¶è¡¨æ¯”ä¾‹**
- **ç£ç›˜IOè¯»å†™é€ŸçŽ‡**

## å®žé™…æµ‹è¯•ç»“æžœ

æµ‹è¯•å®žä¾‹: **192.168.44.71**

```json
{
  "connections": 1.0,
  "max_connections": 800.0,
  "connection_usage": 0.12,
  "threads_running": 1.0,

  "buffer_pool_hit_rate": 92.92,
  "buffer_pool_usage": 95.69,

  "replication_lag": 0.0,
  "slave_io_running": 1.0,
  "slave_sql_running": 1.0,

  "innodb_row_lock_waits": 0.0,
  "innodb_row_lock_time_avg": 0.0,
  "table_locks_waited": 0.0,

  "slow_queries_rate": 0.0,

  "cpu_usage": 0.02,
  "memory_usage_mb": 26.68
}
```

## å‘Šè­¦é˜ˆå€¼è¯´æ˜Ž

### ðŸ”´ çº¢è‰²å‘Šè­¦ï¼ˆå±é™©ï¼‰
- è¿žæŽ¥ä½¿ç”¨çŽ‡ â‰¥ 80%
- å¤åˆ¶å»¶è¿Ÿ > 60ç§’
- è¡Œé”ç­‰å¾… â‰¥ 100æ¬¡
- ç£ç›˜ä¸´æ—¶è¡¨æ¯”ä¾‹ â‰¥ 25%
- CPUä½¿ç”¨çŽ‡ > 80%

### ðŸŸ¡ é»„è‰²å‘Šè­¦ï¼ˆè­¦å‘Šï¼‰
- ç¼“å­˜å‘½ä¸­çŽ‡ < 95%
- è„é¡µæ¯”ä¾‹ â‰¥ 10%
- å¤åˆ¶å»¶è¿Ÿ 10-60ç§’
- æ…¢æŸ¥è¯¢é€ŸçŽ‡ â‰¥ 1/ç§’
- è¡¨é”ç­‰å¾… â‰¥ 10æ¬¡
- CPUä½¿ç”¨çŽ‡ 50-80%

### ðŸŸ¢ ç»¿è‰²ï¼ˆæ­£å¸¸ï¼‰
- æ‰€æœ‰æŒ‡æ ‡åœ¨æ­£å¸¸èŒƒå›´å†…

## é…ç½®è¯´æ˜Ž

### Prometheusé…ç½® (config.json)

```json
{
  "prometheus": {
    "enabled": true,
    "url": "http://192.168.98.4:20001",
    "timeout": 5,
    "scrape_interval": "15s"
  }
}
```

### å®žä¾‹æ˜ å°„é…ç½®

```json
{
  "exporter_mapping": {
    "192.168.44.71": "http://192.168.98.4:19987",
    "192.168.46.101": "http://192.168.98.4:19993",
    "192.168.46.102": "http://192.168.98.4:19998",
    "192.168.44.141": "http://192.168.98.4:19994",
    "10.111.1.152": "http://192.168.98.4:20010",
    "10.111.3.22": "http://192.168.98.4:20011"
  }
}
```

## APIæŽ¥å£

### 1. æ£€æŸ¥Prometheuså¥åº·çŠ¶æ€

```bash
curl http://localhost:5000/api/prometheus/health
```

å“åº”ç¤ºä¾‹:
```json
{
  "enabled": true,
  "healthy": true,
  "success": true,
  "url": "http://192.168.98.4:20001"
}
```

### 2. èŽ·å–å®žä¾‹æŒ‡æ ‡

```bash
curl http://localhost:5000/api/prometheus/metrics/192.168.44.71
```

å“åº”: åŒ…å«30+é¡¹æŒ‡æ ‡çš„JSON

### 3. èŽ·å–è¶‹åŠ¿æ•°æ®

```bash
curl "http://localhost:5000/api/prometheus/trends/192.168.44.71?hours=24"
```

å‚æ•°:
- `hours`: æŸ¥è¯¢æœ€è¿‘Nå°æ—¶çš„æ•°æ®ï¼ˆé»˜è®¤24ï¼‰

### 4. æ‰§è¡Œè‡ªå®šä¹‰PromQLæŸ¥è¯¢

```bash
curl -X POST http://localhost:5000/api/prometheus/query \
  -H "Content-Type: application/json" \
  -d '{
    "query": "mysql_global_status_threads_connected{ip=\"192.168.44.71\"}",
    "type": "instant"
  }'
```

## PromQLæŸ¥è¯¢ç¤ºä¾‹

ç³»ç»Ÿä½¿ç”¨çš„å…³é”®PromQLæŸ¥è¯¢ï¼ˆå·²ä¿®æ­£ä¸ºä½¿ç”¨ipæ ‡ç­¾ï¼‰ï¼š

### è¿žæŽ¥æ•°
```promql
mysql_global_status_threads_connected{ip="192.168.44.71"}
```

### æœ€å¤§è¿žæŽ¥æ•°
```promql
mysql_global_variables_max_connections{ip="192.168.44.71"}
```

### QPS (æ¯ç§’æŸ¥è¯¢æ•°)
```promql
rate(mysql_global_status_questions{ip="192.168.44.71"}[1m])
```

### TPS (æ¯ç§’äº‹åŠ¡æ•°)
```promql
rate(mysql_global_status_commands_total{command="commit",ip="192.168.44.71"}[1m])
+ ignoring(command) rate(mysql_global_status_commands_total{command="rollback",ip="192.168.44.71"}[1m])
```

### Buffer Poolå‘½ä¸­çŽ‡
```promql
(mysql_global_status_innodb_buffer_pool_read_requests{ip="192.168.44.71"}
- mysql_global_status_innodb_buffer_pool_reads{ip="192.168.44.71"})
/ mysql_global_status_innodb_buffer_pool_read_requests{ip="192.168.44.71"} * 100
```

### å¤åˆ¶å»¶è¿Ÿ
```promql
mysql_slave_status_seconds_behind_master{ip="192.168.44.71"}
```

## æ•…éšœæŽ’æŸ¥

### é—®é¢˜1: "PrometheusæœåŠ¡ä¸å¯ç”¨"

**æ£€æŸ¥æ­¥éª¤**:

1. æµ‹è¯•Prometheuså¥åº·ç«¯ç‚¹
```bash
curl http://192.168.98.4:20001/-/healthy
```
åº”è¿”å›ž: "Prometheus Server is Healthy."

2. æ£€æŸ¥é…ç½®æ–‡ä»¶
```bash
cat config.json | grep prometheus
```

3. æ£€æŸ¥ç½‘ç»œè¿žæŽ¥
```bash
ping 192.168.98.4
```

### é—®é¢˜2: æŒ‡æ ‡æ˜¾ç¤ºä¸ºnull

**å¯èƒ½åŽŸå› **:
- PromQLæŸ¥è¯¢è¯­æ³•ä¸æ­£ç¡®
- è¯¥æŒ‡æ ‡åœ¨MySQL Exporterä¸­ä¸å­˜åœ¨
- instance/ipæ ‡ç­¾ä¸åŒ¹é…

**è§£å†³æ–¹æ³•**:

1. ç›´æŽ¥è®¿é—®ExporteræŸ¥çœ‹å¯ç”¨æŒ‡æ ‡
```bash
curl http://192.168.98.4:19987/metrics | grep mysql_global_status_threads_connected
```

2. åœ¨Prometheusç•Œé¢æµ‹è¯•æŸ¥è¯¢
- è®¿é—® http://192.168.98.4:20001
- åœ¨æŸ¥è¯¢æ¡†è¾“å…¥PromQLæµ‹è¯•

3. æ£€æŸ¥targetsçŠ¶æ€
```bash
curl http://192.168.98.4:20001/api/v1/targets
```

### é—®é¢˜3: ä»£ç†é—®é¢˜

å¦‚æžœçŽ¯å¢ƒä¸­è®¾ç½®äº†HTTPä»£ç†ï¼Œå¯èƒ½å¯¼è‡´æ— æ³•è®¿é—®å†…ç½‘Prometheusã€‚

**è§£å†³**: ä»£ç ä¸­å·²æ·»åŠ ç¦ç”¨ä»£ç†çš„é…ç½®
```python
self.proxies = {
    'http': None,
    'https': None
}
```

æ‰€æœ‰requestsè°ƒç”¨éƒ½ä½¿ç”¨`proxies=self.proxies`å‚æ•°ã€‚

## å·²çŸ¥é—®é¢˜å’Œå¾…ä¼˜åŒ–é¡¹

### âš ï¸ QPS/TPSæŸ¥è¯¢è¿”å›žnull

**åŽŸå› **: å¯èƒ½æ˜¯PromQLæŸ¥è¯¢çš„metricåç§°ä¸æ­£ç¡®ï¼Œæˆ–rateå‡½æ•°çš„æ—¶é—´çª—å£ä¸åˆé€‚ã€‚

**å¾…ä¿®å¤**: éœ€è¦æŸ¥çœ‹å®žé™…çš„Exporter metricsï¼Œç¡®è®¤æ­£ç¡®çš„metricåç§°ã€‚

### âš ï¸ ä¸´æ—¶è¡¨æŒ‡æ ‡è¿”å›žnull

**åŽŸå› **: åŒä¸Šï¼Œmetricåç§°å¯èƒ½ä¸åŒ¹é…ã€‚

**å¾…ä¿®å¤**: æŸ¥çœ‹Exporterä¸­æ˜¯å¦æœ‰`mysql_global_status_created_tmp_tables`ç­‰æŒ‡æ ‡ã€‚

### âš ï¸ ç£ç›˜IOæŒ‡æ ‡è¿”å›žnull

**åŽŸå› **: åŒä¸Šã€‚

**å¾…ä¿®å¤**: ç¡®è®¤`mysql_global_status_innodb_data_reads`ç­‰æŒ‡æ ‡æ˜¯å¦å­˜åœ¨ã€‚

## ä¸‹ä¸€æ­¥ä¼˜åŒ–

### 1. ä¿®å¤nullæŒ‡æ ‡ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

æŸ¥çœ‹å®žé™…çš„Exporter metricsåˆ—è¡¨ï¼š
```bash
curl http://192.168.98.4:19987/metrics | grep mysql_global_status | head -50
```

æ ¹æ®å®žé™…çš„metricåç§°è°ƒæ•´prometheus_client.pyä¸­çš„æŸ¥è¯¢ã€‚

### 2. æ·»åŠ è¶‹åŠ¿å›¾è¡¨ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

é›†æˆChart.jsæˆ–EChartsï¼Œæ˜¾ç¤ºï¼š
- QPS/TPS 24å°æ—¶è¶‹åŠ¿
- è¿žæŽ¥æ•°è¶‹åŠ¿
- Buffer Poolå‘½ä¸­çŽ‡è¶‹åŠ¿
- å¤åˆ¶å»¶è¿Ÿè¶‹åŠ¿

### 3. å®žæ–½å‘Šè­¦ç³»ç»Ÿï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

åŸºäºŽé˜ˆå€¼è‡ªåŠ¨å‘é€å‘Šè­¦ï¼š
- é‚®ä»¶é€šçŸ¥
- é’‰é’‰/ä¼ä¸šå¾®ä¿¡Webhook
- å‘Šè­¦åŽ†å²è®°å½•
- å‘Šè­¦ç¡®è®¤å’Œé™é»˜

### 4. æ€§èƒ½åŸºçº¿ï¼ˆä½Žä¼˜å…ˆçº§ï¼‰

å»ºç«‹æ¯ä¸ªå®žä¾‹çš„æ€§èƒ½åŸºçº¿ï¼š
- æ­£å¸¸QPSèŒƒå›´
- æ­£å¸¸è¿žæŽ¥æ•°èŒƒå›´
- å¼‚å¸¸æ£€æµ‹ç®—æ³•

## æŠ€æœ¯æ ˆ

- **åŽç«¯**: Python 3.11, Flask 2.0+
- **Prometheuså®¢æˆ·ç«¯**: requestsåº“
- **å‰ç«¯**: åŽŸç”ŸHTML/CSS/JavaScript
- **Prometheus**: v2.x (http://192.168.98.4:20001)
- **MySQL Exporter**: v0.x (ç«¯å£19987-20011)

## ç›¸å…³æ–‡æ¡£

- `PROMETHEUS_INTEGRATION_PLAN.md` - é›†æˆè§„åˆ’æ–‡æ¡£
- `PROMETHEUS_INTEGRATION_COMPLETE.md` - åŠŸèƒ½è¯¦ç»†è¯´æ˜Ž
- `PROMETHEUS_IMPLEMENTATION_SUMMARY.md` - å®žæ–½æ€»ç»“
- `scripts/prometheus_client.py` - Prometheuså®¢æˆ·ç«¯æºç 
- `config.json` - ç³»ç»Ÿé…ç½®æ–‡ä»¶

## è”ç³»æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥:
1. Flaskåº”ç”¨æ—¥å¿—è¾“å‡º
2. æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŽ§åˆ¶å°
3. PrometheusæœåŠ¡å™¨æ—¥å¿—
4. MySQL Exporteræ—¥å¿—

---

**æœ€åŽæ›´æ–°**: 2026-01-26
**ç‰ˆæœ¬**: v1.0
**çŠ¶æ€**: âœ… ç”Ÿäº§å¯ç”¨ï¼ˆéƒ¨åˆ†æŒ‡æ ‡å¾…ä¼˜åŒ–ï¼‰
